---
title: "Doctypes for IPL (F02) related products"
author: "Bart van Hest (Integration Technology & Services, The Future Group)"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  rmdformats::html_clean:
    toc: true
    toc_depth: 4
    number_sections: true
  word_document: default
  html_document: default
  markdowntemplates::prismskel:
    toc: true
    toc_float: true
---

```{r libs, warning=FALSE, include=FALSE}
#remove.packages(c("DBI", "rJava", "RJDBC"))
#install.packages('rJava', dependencies = TRUE)
#install.packages('RJDBC', dependencies = TRUE)
#install.packages('DBI', dependencies = TRUE)


# load required libraries
library(tidyverse)
library(kableExtra)

library(DBI)
# Set JAVA_HOME, set max. memory, and load rJava library
Sys.setenv(JAVA_HOME='C:/Java/jdk1.8.0_191')
options(java.parameters="-Xmx2g")
# check: https://cran.r-project.org/bin/windows/base/rw-FAQ.html
#        https://stackoverflow.com/questions/37735108/r-error-onload-failed-in-loadnamespace-for-rjava
library(rJava)

# Output Java version
.jinit()
print(.jcall("java/lang/System", "S", "getProperty", "java.version"))

# Load RJDBC library
library(RJDBC)

oracle.JdbcDriver <- 
  RJDBC::JDBC(driverClass="oracle.jdbc.OracleDriver", 
              classPath="c:/Java/Oracle/ojdbc8.jar")

pr.jdbcConnection <- 
  DBI::dbConnect(drv = oracle.JdbcDriver,
                 url = "jdbc:oracle:thin:@130.139.136.60:1521:CCR1P", 
                 user = "bvanhest", 
                 password = "Philips@123")

```

# Introduction



# Data



## IPL (mag='F02') related products


```{r}
# /* 
# Select all F02 (IPL) related products
# */
qry <- 
  "select m.pm_name 
from m_product_model m
   , m_article_group ag
where m.ag_cd = ag.ag_cd
  and ag.mag_cd = 'F02'
order by m.pm_name"

DBI::dbGetQuery(conn = pr.jdbcConnection, 
                statement = qry ) %>%
  kableExtra::kable(caption="IPL (F02) related products") %>%
  kableExtra::kable_styling()
``` 


```
# /*
# select all symcure id relation related to an IPL products
# */
qry <- 
  "select count(*) 
from m_symptom_cure_relation scr,
     (select pm_name 
      from m_product_model m
         , m_article_group ag
      where m.ag_cd = ag.ag_cd
      and ag.mag_cd = 'F02') pm
where scr.pm_name = pm.pm_name"

DBI::dbGetQuery(conn = pr.jdbcConnection, 
                statement = qry ) %>%
  kableExtra::kable(caption="Count of Symptom-cure relations for IPL products") %>%
  kableExtra::kable_styling()
```




```
# /*
# select all symcure id related to IPL products
# */
qry <- 
  "select count(pm.pm_name) 
from m_symptom_cure_relation scr, 
     (select pm_name 
      from m_product_model m
         , m_article_group ag
      where m.ag_cd = ag.ag_cd
      and ag.mag_cd = 'F02') pm,
     m_symptom_cure SC
where scr.pm_name = pm.pm_name
  and scr.sycu_id = sc.sycu_id"

DBI::dbGetQuery(conn = pr.jdbcConnection, 
                statement = qry ) %>%
  kableExtra::kable(caption="Count of Symptom-cure records for IPL products") %>%
  kableExtra::kable_styling()
```

```
# /*
# select the counts per document type for all symcure id related to IPL products
# */
qry <- 
  "select dt_cd as doc_type, count(pm.pm_name) as product_count
from m_symptom_cure SC,
     m_symptom_cure_relation scr, 
     (select pm_name 
      from m_product_model m
         , m_article_group ag
      where m.ag_cd = ag.ag_cd
      and ag.mag_cd = 'F02') pm
where scr.pm_name = pm.pm_name
  and scr.sycu_id = sc.sycu_id
group by sc.dt_cd
order by product_count desc" 
 

DBI::dbGetQuery(conn = pr.jdbcConnection, 
                statement = qry ) %>%
  kableExtra::kable(caption="Product-count per doc-type for Symptom-cure records for IPL products") %>%
  kableExtra::kable_styling()

# /*
# QAD     7862
# GDA      12
# CCT      990
# QAC      10
# TNT      6
# TUT      54
# */
  
```




```
# /*
# Select the count per document type for ALL secured FAQs
# */
qry <- 
  "select sc.dt_cd as doc_type, count(pm.pm_name) as product_count
from m_symptom_cure SC,
     m_symptom_cure_relation scr,
     m_document_type dt, 
     (select pm_name 
      from m_product_model m
         , m_article_group ag
      where m.ag_cd = ag.ag_cd
      and ag.mag_cd = 'F02') pm
where scr.pm_name = pm.pm_name
  and scr.sycu_id = sc.sycu_id
  and dt.dt_cd    = sc.dt_cd
  and dt.dt_restricted_ind = 'Y'
group by sc.dt_cd
order by product_count desc" 

DBI::dbGetQuery(conn = pr.jdbcConnection, 
                statement = qry ) %>%
  kableExtra::kable(caption="Product-count per secured doc-type for Symptom-cure records for IPL products") %>%
  kableExtra::kable_styling()
```



 
```
qry <- 
  "select sc.dt_cd, count(scr.pm_name) as product_count
from m_symptom_cure_relation scr, 
     m_symptom_cure sc,
     m_document_type dt
where scr.sycu_id = sc.sycu_id
and dt.dt_cd = sc.dt_cd
and dt.dt_restricted_ind = 'Y'
group by sc.dt_cd
order by product_count desc"

DBI::dbGetQuery(conn = pr.jdbcConnection, 
                statement = qry ) %>%
  kableExtra::kable(caption="Product-count per secured doc-type for Symptom-cure records for all products") %>%
  kableExtra::kable_styling()
 
# /* Result:
# GSM     108
# SUE      3690
# CCS      2441
# SCE       7893
# RSN      1977
# SUH      10
# GDA      18057
# SCC      9482
# CCT      514468
# GSC      18654
# RSL       1
# SCH      2
# SCP       39
# RSE       1
# RSA      22
# STI        3693
# SUC      6182
# SUM     4353
# GSP      50
# SCO      29204
# GSE      8106
# SDA      68846
# */
```
  
  
   
```{r}
# /*
# Select all products that have a restricted asset linked to it
# */
qry <- 
  "select scr.pm_name as product, 
          count(sc.dt_cd) as doctype_count
from m_symptom_cure_relation scr, 
     m_symptom_cure sc,
     m_document_type dt
where scr.sycu_id=sc.sycu_id
and dt.dt_cd = sc.dt_cd
and dt.dt_restricted_ind = 'Y'
and scr.pm_name = 'SC2001/21' -- has 13 restricted doctypes: 12x CCR, 1x, GDA
group by scr.pm_name
order by scr.pm_name"

#
# DON'T RUN without product selection. Takes too long to complete.
#
DBI::dbGetQuery(conn = pr.jdbcConnection, 
                statement = qry ) %>%
  kableExtra::kable(caption="Products with related secured doc-types") %>%
  kableExtra::kable_styling()
```

Do i understand the results? How is the data made up?

  - SC2003/12	 GDA
SC2003/31	 GDA
SC2001/21	 GDA
SC2001/31	 GDA
SC2003/21	 GDA
SC2001/00	 GDA
SC2002/00	 GDA
SC2003/00	 GDA
SC2000/00	 GDA
SC2002/01	 GDA
SC2001/01	 GDA
SC2003/11


```{r}
# /*
# Select all products that have a restricted asset linked to it
# */
qry <- 
  "select scr.pm_name as product, 
          sc.dt_cd as doctype
from m_symptom_cure_relation scr, 
     m_symptom_cure sc,
     m_document_type dt, 
     (select pm_name 
      from m_product_model m
         , m_article_group ag
      where m.ag_cd = ag.ag_cd
      and ag.mag_cd = 'F02') pm
where scr.pm_name = pm.pm_name
  and scr.sycu_id=sc.sycu_id
and dt.dt_cd = sc.dt_cd
and dt.dt_restricted_ind = 'Y'
and scr.pm_name = 'SC2001/21'
--and sc.dt_cd = 'GDA'
order by doctype"


DBI::dbGetQuery(conn = pr.jdbcConnection, 
                statement = qry ) %>%
  kableExtra::kable(caption="Products with related secured doc-types") %>%
  kableExtra::kable_styling()
```




-- qry om een aantal voorbeeld producten te selecteren: IPL producten bevatten alleen CCT en GDA restricted doc-types.

qry <- 
  "select sc.dt_cd as doc_type, count(pm.pm_name) as product_count
from m_symptom_cure SC,
     m_symptom_cure_relation scr,
     m_document_type dt, 
     (select pm_name 
      from m_product_model m
         , m_article_group ag
      where m.ag_cd = ag.ag_cd
      and ag.mag_cd = 'F02') pm
where scr.pm_name = pm.pm_name
  and scr.sycu_id = sc.sycu_id
  and dt.dt_cd    = sc.dt_cd
  and dt.dt_restricted_ind = 'Y'
group by sc.dt_cd
order by product_count desc"




```{r}
# Close DB connection
#dbDisconnect(pr.jdbcConnection)
```
