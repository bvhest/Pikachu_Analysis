<?xml version="1.0" encoding="UTF-8"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">
	
	<map:pipelines>

		<map:component-configurations>
			<global-variables>
				<ct>LeafletSample</ct>
			</global-variables>
		</map:component-configurations>
	
		<map:pipeline type="noncaching">
			<!-- Here is the main pipeline that executes the batch processing. 
  			In invoking the pipeline the execution timestamp is passed as a parameter along with ct.
  			Input parameters: {1} = timestamp
			-->
			<map:match pattern="runMain/*">        
				<map:act type="copy-source" src="{cmc2:svcURL}/store/save/batch/localised/processfiles/{global:ct}/{1}">
				<!--map:act type="copy-source" src="{cmc2:svcURL}/batch/localised/processfiles/{global:ct}/{1}"-->
					<map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/processBatches_report.xml"/>
				</map:act>				        
				<map:generate src="{cmc2:gdir}/{global:ct}/temp/processBatches_report.xml"/>
				<map:serialize type="xml"/>
			</map:match>
 
 
	       <!-- per-entry processing -->
	      <map:match pattern="process/*/*/**">
	      <!-- {1} localisation {2} timestamp {3} objectId -->      
	        <map:generate src="{cmc2:xmlDir}/empty.xml"/>
	        <!-- create an entry record for the target octl -->
	        <map:transform src="{cmc2:xslDir}/common/create_entry_record.xsl">
	          <map:parameter name="o" value="{3}"/>
	          <map:parameter name="ct" value="{global:ct}"/>
	          <map:parameter name="l" value="{1}"/>
	          <map:parameter name="ts" value="{2}"/>
	        </map:transform>
          <!-- include the content from the source octl -->
	        <map:transform src="xsl/include_content.xsl">
	          <map:parameter name="svcURL" value="{cmc2:svcURL}/"/>
	          <map:parameter name="o" value="{3}"/>
	          <map:parameter name="ct" value="PMT_Enriched"/>
	          <map:parameter name="l" value="{1}"/>
	        </map:transform>
          <map:transform type="cinclude"/>  
		  
		  
          <!-- derive secondaries-->
		  <map:transform src="xsl/secondaryDerivation.xsl"/>
		  <!-- create relations to secondaries-->
	      <map:transform src="{cmc2:xslDir}/common/placeholders_relations.xsl"/>
	      <map:call resource="sql"/>
		  <!-- invalidate octl if secondary relations can not be created-->
		  <map:transform src="{cmc2:xslDir}/common/validate_store_outputs.xsl"/>
		  <map:transform src="{cmc2:xslDir}/common/cleanup-sql.xsl"/>
		  <!-- include secondaries-->
		  <map:transform src="{cmc2:xslDir}/common/get_secondaries.xsl"/>
	      <map:call resource="sql"/>
		  <map:transform src="{cmc2:xslDir}/common/include_secondaries.xsl">
	          <map:parameter name="svcURL" value="{cmc2:svcURL}/"/>
	      </map:transform>
          <map:transform type="cinclude"/>  
		  <!-- invalidate octl if secondaries are missing-->
		  <map:transform src="{cmc2:xslDir}/common/validate_secondary_includes.xsl"/>
		  <map:transform src="{cmc2:xslDir}/common/cleanup-sql.xsl"/>
		  
		  
		  <!-- actual enrichment/processing-->
		  <map:transform src="xsl/enrich.xsl"/>
          <map:transform src="xsl/process_entries.xsl"/>
	      <map:serialize type="xml"/>
	      </map:match>
		</map:pipeline>
	</map:pipelines>
</map:sitemap>
