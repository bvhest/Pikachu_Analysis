<?xml version="1.0" encoding="UTF-8"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">
	
	<map:resources>
		<!-- the sql resource provides a central place to edit database details -->
		<map:resource name="sql">
			<map:transform type="sql">
				<map:parameter name="use-connection" value="oracleDbCMC"/>
				<map:parameter name="clob-encoding" value="UTF-8"/>
			</map:transform>
		</map:resource>
	</map:resources>
	
	<map:pipelines>

		<map:component-configurations>
			<global-variables>
				<ct>content_type_log</ct>
			</global-variables>
		</map:component-configurations>
	
		<map:pipeline type="noncaching">

			
			<!-- Here is the main pipeline that exeutes the batch processing. 
			In invoking the pipeline the execution timestamp is passed as a parameter along with ct.
				Input parameters: {1} = timestamp
				Output Document: ?
			-->
			<map:match pattern="runMain/*">
			
				<map:act type="copy-source" src="{cmc2:svcURL}/batch/localised/createBatches/{global:ct}">
					<map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/createBatches_report.xml"/>
				</map:act>	
				
				<map:act type="copy-source" src="{cmc2:svcURL}/store/save/batch/localised/processBatches/{global:ct}/{1}">
					<map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/processBatches_report.xml"/>
				</map:act>					
				
				<map:generate src="{cmc2:gdir}/{global:ct}/temp/processBatches_report.xml"/>				
				<map:serialize type="xml"/>	
			</map:match>								

			<map:match pattern="process/none/*/**">
			<!-- {1} ts {2} objectId -->			
				<map:generate src="{cmc2:xmlDir}/empty.xml"/>
				<map:transform src="{cmc2:xslDir}/common/create_entry_record.xsl">
					<map:parameter name="o" value="{2}"/>
					<map:parameter name="ct" value="{global:ct}"/>
					<map:parameter name="l" value="none"/>
					<map:parameter name="ts" value="{1}"/>
				</map:transform>
				<map:transform src="xsl/include-content.xsl">
					<map:parameter name="svcURL" value="{cmc2:svcURL}/"/>
				</map:transform>
				<map:transform type="include"/>		
				<!-- the actual processing -->
				<map:transform src="xsl/process_entries.xsl"/>
				<map:call resource="sql"/>
				<map:transform src="{cmc2:xslDir}/common/cleanup-sql.xsl"/>
				<map:serialize type="xml"/>
			</map:match>
			
		</map:pipeline>
	</map:pipelines>
</map:sitemap>
