<?xml version="1.0" encoding="UTF-8"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

  <map:resources>
    <!-- The sql resource provides a central place to edit database details -->
    <map:resource name="sql">
      <map:transform type="sql">
        <map:parameter name="use-connection" value="oracleDbCMC"/>
        <map:parameter name="clob-encoding" value="UTF-8"/>
      </map:transform>
    </map:resource>    
  </map:resources>

  <map:pipelines>
    <map:component-configurations>
      <global-variables>
        <ct>LogisticData</ct>
      </global-variables>
    </map:component-configurations>
    
    <map:pipeline type="noncaching">
      <!--+
          | Here is the main pipeline that executes the batch processing. 
          | In invoking the pipeline the execution timestamp is passed as a
          | parameter.
           
          | Parameters:
          | 1) timestamp
          |
          | Output: OCTL-entry
          |
          | Assumption:
          | - Inbox data is filled by CCR
          |
          | Process steps:
          | - Batch inbox files
          | - Create/update OCTL
          +-->
      <map:match pattern="runMain/*">
        <!-- Delete unmodified inbox contents -->
        <map:act type="copy-source" src="cocoon:/deleteUnmodifiedInboxFiles">
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/deleteUnmodifiedInboxFiles_report.xml"/>
        </map:act>
        <!-- Batch inbox contents -->
        <map:act type="copy-source" src="{cmc2:svcURL}/batch/import/createBatches/{global:ct}/{1}?sourcedir={cmc2:gdir}/{global:ct}/inbox">
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/createBatches_report.xml"/>
        </map:act>
        <!-- Create/update OCTL -->
        <map:act type="copy-source" src="{cmc2:svcURL}/store/deltaSave/batch/import/processBatches/{global:ct}/{1}?createPlaceholder=y">
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/processBatches_report.xml"/>
        </map:act>
        <!-- Move files from the inbox- to the cached or processed directory -->
        <map:act type="copy-source" src="cocoon:/archiveInboxFiles">
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/archiveInboxFiles_report.xml"/>
        </map:act>
        <!-- Generate the report -->
        <map:aggregate element="report">
          <map:part src="{cmc2:gdir}/{global:ct}/temp/deleteUnmodifiedInboxFiles_report.xml"/>
          <map:part src="{cmc2:gdir}/{global:ct}/temp/createBatches_report.xml"/>
          <map:part src="{cmc2:gdir}/{global:ct}/temp/processBatches_report.xml"/>
          <map:part src="{cmc2:gdir}/{global:ct}/temp/archiveInboxFiles_report.xml"/>
        </map:aggregate>
        <map:serialize type="xml"/>
      </map:match>

      <!--+
          | Get all the files in the inbox.
          +-->
      <map:match pattern="getInboxFiles">
        <map:generate type="directory" src="{cmc2:gdir}/{global:ct}/inbox">
          <map:parameter name="dateFormat" value="yyyy-MM-dd HH:mm"/>
          <map:parameter name="depth" value="1"/>
          <map:parameter name="include" value=".*\.xml"/>
        </map:generate>
        <map:serialize type="xml"/>
      </map:match>
      
      <!--+
          | Delete those files in the inbox which have identical counterparts in
          | the cache directory.
          +-->
      <map:match pattern="deleteUnmodifiedInboxFiles">
        <!-- Find products that were modified since the last feed -->
        <map:generate src="cocoon:/getInboxFiles"/>
        <map:transform type="xslt-saxon" src="xsl/deleteUnmodifiedInboxFiles.xsl">
          <map:parameter name="ctDir" value="{cmc2:gdir}/{global:ct}"/>
        </map:transform>
        <map:transform type="shell"/>
        <map:serialize type="xml"/>
      </map:match>
      
      <!--+
          | Parameters:
          | 1) batch number (unused)
          | 2) timestamp
          | 3) file
          | 
          | Test: http://localhost:8888/cmc2/content_type/LogisticData/process/1/20120919000000/DE_19PFL3606H_12.xml
          +-->      
      <map:match pattern="process/*/*/**">
        <map:generate src="{cmc2:gdir}/{global:ct}/inbox/{3}"/>
        <map:transform type="xslt-saxon" src="xsl/sql_createOctlEntry.xsl">
          <map:parameter name="ct" value="{global:ct}"/>
          <map:parameter name="ts" value="{2}"/>
          <map:parameter name="reload" value="{request-param:reload}"/>
        </map:transform>
        <map:call resource="sql"/>
        <map:serialize type="xml"/>
      </map:match>
      
      <!--+
          | Archive the files in the inbox to either cache if successfully
          | stored to OCTL or processed if not successful.
          +-->
      <map:match pattern="archiveInboxFiles">
        <map:aggregate element="root">
          <map:part src="cocoon:/getInboxFiles"/>
          <map:part src="{cmc2:gdir}/{global:ct}/temp/processBatches_report.xml"/>
        </map:aggregate>
        <map:transform src="xsl/archiveInboxFiles.xsl">
          <map:parameter name="sourceDir" value="{cmc2:gdir}/{global:ct}/inbox"/>
          <map:parameter name="targetDir" value="{cmc2:gdir}/{global:ct}/cache"/>
          <map:parameter name="ignoredDir" value="{cmc2:gdir}/{global:ct}/processed"/>
        </map:transform>
        <map:transform type="shell"/>
        <map:serialize type="xml"/>
      </map:match>
    </map:pipeline>
  </map:pipelines>
</map:sitemap>
