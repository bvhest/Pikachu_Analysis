<?xml version="1.0" encoding="UTF-8"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

  <map:components>
    <map:transformers>
      <map:transformer name="sendmail" src="org.apache.cocoon.mail.transformation.SendMailTransformer">
        <smtphost>nlvg020.gdc1.ce.philips.com</smtphost>
        <smtpport>25</smtpport>
      </map:transformer>
    </map:transformers>        
    <map:actions>
      <map:action name="synced-copy-source" src="org.apache.cocoon.acting.SyncedCopySourceAction"/>
    </map:actions>    
  </map:components>

	<!-- -->
	<map:pipelines>
		<map:pipeline type="noncaching">

		      <map:match pattern="runLockTest/*">
		        <map:act type="synced-copy-source" src="cocoon:/runNotLocked/{1}">
		          <map:parameter name="lockName" value="{1}"/>
		          <map:parameter name="dest" value="{cmc2:gdir}/{1}/temp/save_locktest_log.xml"/>
		          <map:generate src="{cmc2:gdir}/{../1}/temp/save_locktest_log.xml"/>
		          <map:serialize type="xml"/>
		        </map:act>
		        <map:generate src="{cmc2:xmlDir}/locked.xml"/>
		        <map:serialize type="xml"/>
		      </map:match>

		      <map:match pattern="runNotLocked/*">
		        <map:generate src="{cmc2:xmlDir}/unlocked.xml"/>
		        <map:serialize type="xml"/>
		      </map:match>      

		      <map:match pattern="*">
		        <map:act type="synced-copy-source" src="cocoon:/runLocked/{1}">
		          <map:parameter name="lockName" value="{1}"/>
		          <map:parameter name="dest" value="{cmc2:gdir}/{1}/temp/save_process_log.xml"/>
		          <map:generate src="{cmc2:gdir}/{../1}/temp/save_process_log.xml"/>
		          <map:serialize type="xml"/>
		        </map:act>
		        <map:generate src="{cmc2:xmlDir}/locked.xml"/>
		        <map:serialize type="xml"/>
		      </map:match>
				
			<map:match pattern="runLocked/*">
				<map:act type="copy-source" src="cocoon:/startMain/{1}">
					<map:parameter name="dest" value="{cmc2:gdir}/{1}/temp/startMain_report.xml"/>
				</map:act>				
				<map:act type="copy-source" src="{cmc2:svcURL}/processControl/end/{1}">
					<map:parameter name="dest" value="{cmc2:gdir}/{1}/temp/end_report.xml"/>
				</map:act>
				<map:generate src="{cmc2:gdir}/{1}/temp/startMain_report.xml"/>
				<map:serialize type="xml"/>
			</map:match>
			
			<map:match pattern="startMain/*">
				<map:generate src="{cmc2:svcURL}/processControl/runStart/{1}"/>
				<map:transform type="xslt-saxon" src="{cmc2:xslDir}/common/include_runMain.xsl">
					<map:parameter name="ct" value="{1}"/>
				</map:transform>
				<map:transform type="cinclude"/>
				<map:serialize type="xml"/>
			</map:match>
			
			<map:match pattern="runMain/*/*">
            <map:generate src="cocoon:/{1}/runMain/{2}"/>
            <map:transform type="xslt-saxon" src="{cmc2:xslDir}/common/cleanup-report.xsl"/>
            <map:transform type="xslt-saxon" src="{cmc2:xslDir}/common/processReport.xsl">
               <map:parameter name="dir" value="{cmc2:gdir}"/>
               <map:parameter name="ct" value="{1}"/>
               <map:parameter name="ts" value="{2}"/>
            </map:transform>
            <map:transform type="write-source"/>

            <map:transform type="xslt-saxon" src="{cmc2:xslDir}/common/generateErrorsEmail.xsl">
               <map:parameter name="ct" value="{1}"/>        
               <map:parameter name="server" value="{cmc2:cocoonServer}"/>
               <map:parameter name="sender" value="{cmc2:emailSender}"/>
               <map:parameter name="recipient" value="{cmc2:emailRecipient}"/>
            </map:transform>
            <map:transform type="sendmail"/>	
            <map:serialize type="xml"/>	
			</map:match>
      
      
			<map:match pattern="*/export">
				<map:generate src="{cmc2:gdir}/{1}/temp/processBatches_report.xml"/>
				<map:transform src="{cmc2:xslDir}/common/writeOctlData.xsl">
					<map:parameter name="dir" value="{cmc2:gdir}"/>
					<map:parameter name="svcURL" value="{cmc2:svcURL}"/>
				</map:transform>
				<map:transform type="cinclude"/>
				<map:transform src="{cmc2:xslDir}/common/stripNamespace.xsl"/>
				<map:transform type="write-source"/>		
				<map:serialize type="xml"/>	
			</map:match>
			
            <!--
              Get a content type specific 'source' file.
              {1} content type
              {2} path to stylesheet
              
              E.g. get_ct_file/PMT/xsl/create_entry_record.xsl
            -->
            <map:match pattern="get_ct_file/*/**">
              <map:select type="resource-exists">
                <!-- If the file exists directly in the content type directory, return it -->
                <map:when test="{cmc2:ctDir}/{1}/{2}">
                  <map:generate src="{cmc2:ctDir}/{1}/{2}" />
                </map:when>
                <!-- If the file exists in a subdirectory bsaed on the pubSystemId CMC2 property, return it -->
                <map:when test="{cmc2:ctDir}/{1}/{1}_{cmc2:pubSystemId}/{2}">
                  <map:generate src="{cmc2:ctDir}/{1}/{1}_{cmc2:pubSystemId}/{2}" />
                </map:when>
                <!-- Otherwise let the content type handle the request -->
                <map:otherwise>
                  <map:generate src="cocoon:/{1}/get_ct_file/{2}"/>
                </map:otherwise>
              </map:select>
			  <map:serialize type="xml"/>
            </map:match>

			<!-- -->
			<map:match pattern="*/**">
				<map:mount check-reload="yes" src="{1}/" uri-prefix="{1}"/>
			</map:match>
			<!-- -->
			
		
			
		</map:pipeline>
	</map:pipelines>
  
  <!-- -->
</map:sitemap>
