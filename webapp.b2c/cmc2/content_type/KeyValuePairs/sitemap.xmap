<?xml version="1.0" encoding="UTF-8"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

  <map:resources>
    <!-- the sql resource provides a central place to edit database details -->
    <map:resource name="sql">
      <map:transform type="sql">
        <map:parameter name="use-connection" value="oracleDbCMC"/>
        <map:parameter name="clob-encoding" value="UTF-8"/>
      </map:transform>
    </map:resource>
  </map:resources>
  <map:pipelines>
  <!-- -->
    <map:component-configurations>
      <global-variables>
        <ct>KeyValuePairs</ct>
      </global-variables>
    </map:component-configurations>
    <!-- -->
    <map:pipeline type="noncaching">

      <!-- Here is the main pipeline that exeutes the batch processing.
      In invoking the pipeline the execution timestamp is passed as a parameter along with ct.
        Input parameters: {1} = timestamp
        Output Document: Result of writing the report document to file
      -->
      <map:match pattern="runMain/*">
        <!-- Create the external table file -->
        <map:act type="copy-source" src="cocoon:/processFiles?destination=keyvaluepairs.dat">
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/createExternalTableFiles_report.xml"/>
        </map:act>
        <!-- Create OCTL_STORE content -->
        <map:act type="copy-source" src="{cmc2:svcURL}/store/importExecDelta/batch/import/processFiles/{global:ct}/{1}?includefilepattern=KeyValuePairs&amp;createPlaceholder=y">
 <!--map:act type="copy-source" src="{cmc2:svcURL}/batch/import/processFiles/{global:ct}/{1}?includefilepattern=KeyValuePairs&amp;createPlaceholder=y"-->
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/processKeyValuePairFiles_report.xml"/>
        </map:act>       
        <map:act type="copy-source" src="{cmc2:svcURL}/processControl/archiveFiles/inbox/{global:ct}">
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/archive_report.xml"/>
        </map:act>
        <map:aggregate  element="reports">
          <map:part  src="{cmc2:gdir}/{global:ct}/temp/createExternalTableFiles_report.xml"/>
          <map:part src="{cmc2:gdir}/{global:ct}/temp/processKeyValuePairFiles_report.xml"/>
        </map:aggregate>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="processFiles">
        <map:generate type="directory" src="{cmc2:gdir}/{global:ct}/inbox">
          <map:parameter name="depth" value="1"/>
          <map:parameter name="include" value=".*\.xml"/>
        </map:generate>
        <map:transform type="xslt-saxon" src="xsl/include2transformXML.xsl">
          <map:parameter name="destination" value="{request-param:destination}"/>
        </map:transform>
        <map:transform type="cinclude"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="transformXMLToExternalTable/*">
        <map:act type="copy-source" src="cocoon:/transformXMLToExternalTable_sub/{1}">
          <map:parameter name="dest" value="{cmc2:oradata_extDir}/keyvaluepairs/{request-param:destination}"/>
        </map:act>
         <map:generate src="{cmc2:xmlDir}/empty.xml"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="transformXMLToExternalTable_sub/*">
        <map:generate src="{cmc2:gdir}/{global:ct}/inbox/{1}"/>
        <map:transform type="xslt-saxon" src="xsl/transformXMLToExternalTable.xsl"/>
        <map:serialize type="text"/>
      </map:match>
	  <!-- -->
	</map:pipeline>
      <!-- -->
  </map:pipelines>
</map:sitemap>
