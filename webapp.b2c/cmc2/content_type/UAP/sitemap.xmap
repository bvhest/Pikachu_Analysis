<?xml version="1.0" encoding="UTF-8"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

  <map:resources>
    <map:resource name="sql">
      <map:transform type="sql">
        <map:parameter name="use-connection" value="oracleDbCMC"/>
        <map:parameter name="clob-encoding" value="UTF-8"/>
      </map:transform>
    </map:resource>
  </map:resources>
  <!-- -->
  <map:pipelines>
    <map:component-configurations>
      <global-variables>
        <ct>UAP</ct>
      </global-variables>
    </map:component-configurations>
    <!-- -->
    <map:pipeline type="noncaching">
    
      <map:match pattern="runMain/*">
        <map:act type="copy-source" src="cocoon:/mergeInbox/{1}">
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/merge-inbox.xml"/>
        </map:act>
        
        <map:act type="copy-source" src="cocoon:/processInbox/{1}">
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/process-inbox.xml"/>
        </map:act>
        
        <map:aggregate element="root">
          <map:part src="{cmc2:gdir}/{global:ct}/temp/merge-inbox.xml"/>
          <map:part src="{cmc2:gdir}/{global:ct}/temp/process-inbox.xml"/>
        </map:aggregate>
        
        <map:act type="copy-source" src="cocoon:/archiveFiles">
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/archive_report.xml"/>
        </map:act>
        
        <map:serialize type="xml"/>  
      </map:match>
        
      <map:match pattern="mergeInbox/*">
        <map:generate type="directory" src="{cmc2:gdir}/{global:ct}/inbox">
          <map:parameter name="dateFormat" value="yyyy-MM-dd HH:mm"/>
          <map:parameter name="depth" value="1"/>
          <map:parameter name="include" value="^UAP_(CCR|PFS)_\w+\.xml$"/>
        </map:generate>

        <map:transform type="xslt-saxon" src="xsl/includeUAPGroups.xsl">
          <map:parameter name="dir" value="{cmc2:gdir}/{global:ct}/inbox"/>
          <map:parameter name="removeDir" value="{cmc2:gdir}/{global:ct}/inbox"/>
        </map:transform>
    
        <map:transform type="cinclude"/>
        <map:transform type="xslt-saxon" src="xsl/updateUAPInbox.xsl">
          <map:parameter name="dir" value="{cmc2:gdir}/{global:ct}/inbox"/>
          <map:parameter name="targetDir" value="{cmc2:gdir}/{global:ct}/inbox"/>
        </map:transform>
               
        <map:transform type="shell"/>
        <map:transform type="write-source"/>
        
        <map:serialize type="xml"/>
      </map:match>
      
      <map:match pattern="processInbox/*">
        <map:act type="copy-source" src="{cmc2:svcURL}/batch/import/createBatches/{global:ct}/{1}?fileFilter=UAP_\w%2B\.xml">
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/createBatches_report.xml"/>
        </map:act>

        <map:act type="copy-source" src="{cmc2:svcURL}/store/deltaSave/batch/import/processBatches/{global:ct}/{1}?createPlaceholder=y">
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/processBatches_report.xml"/>
        </map:act>

        <map:generate src="{cmc2:gdir}/{global:ct}/temp/processBatches_report.xml"/>
        <!-- clean up "More recent document exists" failures -->
        <map:transform src="xsl/cleanup_report.xsl"/>
        <map:serialize type="xml"/>            
      </map:match>

      <!--+
          | Move inbox files that were successfully imported to the cache.
          +-->
      <map:match pattern="archiveFiles">
        <map:aggregate element="root">
          <map:part src="cocoon:/inboxFiles"/>
          <map:part src="{cmc2:gdir}/{global:ct}/temp/process-inbox.xml"/>
        </map:aggregate>
        <map:transform src="xsl/dir2archiveInboxFiles.xsl">
          <map:parameter name="sourceDir" value="{cmc2:gdir}/{global:ct}/inbox"/>
          <map:parameter name="targetDir" value="{cmc2:gdir}/{global:ct}/cache"/>
          <map:parameter name="ignoredDir" value="{cmc2:gdir}/{global:ct}/processed"/>
        </map:transform>
        <map:transform type="shell"/>
        <map:serialize type="xml"/>
      </map:match>

      <map:match pattern="inboxFiles">
        <map:generate type="directory" src="{cmc2:gdir}/{global:ct}/inbox">
          <map:parameter name="dateFormat" value="yyyy-MM-dd HH:mm"/>
          <map:parameter name="depth" value="1"/>
          <map:parameter name="include" value="^UAP_\w+\.xml$"/>
        </map:generate>
        <map:serialize type="xml"/>
      </map:match>

      <map:match pattern="process/*/*/**">
        <!-- {1} batchnumber {2} timestamp {3} filename -->
        <map:generate src="{cmc2:gdir}/{global:ct}/inbox/{3}"/>
        <map:transform type="xslt-saxon" src="xsl/create_entry_records.xsl">
          <map:parameter name="ct" value="{global:ct}"/>
          <map:parameter name="l" value="none"/>
          <map:parameter name="batchnumber" value="{1}"/>
          <map:parameter name="ts" value="{2}"/>
          <map:parameter name="dir" value="{cmc2:gdir}/{global:ct}/cache"/>
        </map:transform>
        <map:call resource="sql"/>
        <map:serialize type="xml"/>
      </map:match>
          
      <map:match pattern="readFile/*">
        <map:generate src="{cmc2:gdir}/{global:ct}/temp/{1}"/>
        <map:serialize type="xml"/>
      </map:match>
      
      <map:match pattern="checkInbox/*">
        <map:generate type="directory" src="{cmc2:gdir}/{global:ct}/inbox">
          <map:parameter name="dateFormat" value="yyyy-MM-dd hh:mm"/>
          <map:parameter name="depth" value="1"/>
          <map:parameter name="include" value=".*"/>
        </map:generate>
        
        <map:transform type="xslt-saxon" src="xsl/checkInbox.xsl">
          <map:parameter name="ts" value="{1}"/>
        </map:transform>                
        <map:transform type="cinclude"/>
        
        <map:serialize type="xml"/>
      </map:match>
      
      <!-- process a group of UAPs, all for the same user account -->
      <map:match pattern="processUAPGroups/**">
        <map:generate src="{cmc2:xmlDir}/empty.xml"/>
        
        <map:transform src="xsl/prepareMerge.xsl">
          <map:parameter name="files" value="{1}"/>
          <map:parameter name="source-folder" value="{cmc2:gdir}/{global:ct}/inbox"/>
          <map:parameter name="cache-folder" value="{cmc2:gdir}/{global:ct}/cache"/>
          <map:parameter name="processed-folder" value="{cmc2:gdir}/{global:ct}/processed"/>
        </map:transform>
                
        <map:transform type="cinclude"/>      
        <map:transform type="shell"/>
        <map:transform type="xslt-saxon" src="xsl/mergeUAPGroups.xsl"/>
               
        <!-- sort before compare with cache -->       
        <map:transform type="xslt-saxon" src="xsl/sortUAPGroups.xsl"/>        
                
        <map:serialize type="xml"/>
      </map:match>
      
      <!-- 
        Read a file and return the empty XML file if it doesn't exist.
        {1} Full file path
      -->
      <map:match pattern="readFile/**">
        <map:select type="resource-exists">
          <map:when test="{1}">
            <map:generate src="{1}"/>
          </map:when>
          <map:otherwise>
            <!-- leave file it will be moved to cache during archive-->
            <map:generate src="{cmc2:xmlDir}/empty.xml"/>
          </map:otherwise>
        </map:select>
        <map:serialize type="xml"/>
      </map:match>
      
    </map:pipeline>
    
  </map:pipelines>
</map:sitemap>
