<?xml version="1.0" encoding="UTF-8"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

  <map:resources>
    <map:resource name="sql">
      <map:transform type="sql">
        <map:parameter name="use-connection" value="oracleDbCMC"/>
        <map:parameter name="clob-encoding" value="UTF-8"/>
      </map:transform>
    </map:resource>
  </map:resources>
  <!-- -->
  <map:pipelines>
    <map:component-configurations>
      <global-variables>
        <ct>PCT_Raw</ct>
      </global-variables>
    </map:component-configurations>
    <!-- -->
    <map:pipeline type="noncaching">
   
    
      <map:match pattern="runMain/*">
        
        <!--map:act type="copy-source" src="cocoon:/preFilterFiles">
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/preFilterFiles.xml"/>
        </map:act-->
       
        <!--map:act type="copy-source" src="{cmc2:svcURL}/batch/import/createBatches/{global:ct}/{1}">
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/createBatches_report.xml"/>
        </map:act-->

				<map:act type="copy-source" src="{cmc2:svcURL}/store/save/batch/import/processFiles/{global:ct}/{1}">
					<map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/processFiles_report.xml"/>
				</map:act>	 
        <map:act type="copy-source" src="cocoon:/archiveFiles">
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/archive_report.xml"/>
        </map:act>
 
        <map:generate src="{cmc2:gdir}/{global:ct}/temp/processFiles_report.xml"/>
        <map:serialize type="xml"/>
      </map:match>
      
      <!-- -->
      <map:match pattern="process/*/*/**">
        <!-- {1} batchnumber {2} timestamp {3} filename -->
        <map:generate src="{cmc2:gdir}/{global:ct}/inbox/{3}"/>
        <map:transform type="xslt-saxon" src="xsl/create_entry_records.xsl">
          <map:parameter name="ct" value="{global:ct}"/>
          <map:parameter name="l" value="none"/>
          <map:parameter name="batchnumber" value="{1}"/>
          <map:parameter name="ts" value="{2}"/>
          <map:parameter name="dir" value="{cmc2:gdir}/{global:ct}/cache"/>
        </map:transform>
        <map:call resource="sql"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="preFilterFiles">
        <map:generate type="directory" src="{cmc2:gdir}/{global:ct}/inbox">
          <map:parameter name="dateFormat" value="yyyy-MM-dd hh:mm"/>
          <map:parameter name="depth" value="1"/>
          <map:parameter name="include" value=".*\.xml"/>
        </map:generate>
        <map:transform type="xslt-saxon" src="xsl/include_dir2process.xsl">
          <map:parameter name="process" value="filterFile"/>
        </map:transform>
        <map:transform type="cinclude"/>
         <map:serialize type="xml"/>
      </map:match>
    <!-- -->
      <map:match pattern="filterFile/*.*.*">
         <map:select type="resource-exists">
            <map:when test="{cmc2:gdir}/{global:ct}/cache/{1}.{2}.{3}">
              <map:aggregate element="ProductsToCompare">
                <map:part src="{cmc2:gdir}/{global:ct}/inbox/{1}.{2}.{3}"/>
                <map:part src="{cmc2:gdir}/{global:ct}/cache/{1}.{2}.{3}"/>
              </map:aggregate>
               <map:transform src="xsl/cleanup-forCompare.xsl"/>
               <map:transform src="xsl/compareContent.xsl"/>
               <map:transform src="xsl/removeFile.xsl">
                  <map:parameter name="source" value="{cmc2:gdir}/{global:ct}/inbox/{1}.{2}.{3}"/>
               </map:transform>
               <map:transform type="shell"/>
            </map:when>
            <map:otherwise>
              <!-- leave file it will be moved to cache during archive-->
              <map:generate src="{cmc2:xmlDir}/empty.xml"/>
            </map:otherwise>
         </map:select>
         <map:serialize type="xml"/>
      </map:match>
      
        <map:match pattern="archiveFiles">
        <map:generate type="directory" src="{cmc2:gdir}/{global:ct}/inbox">
          <map:parameter name="dateFormat" value="yyyy-MM-dd hh:mm"/>
          <map:parameter name="depth" value="1"/>
          <map:parameter name="include" value=".*"/>
        </map:generate>
        <!-- Move files to archive -->
        <map:transform src="xsl/dir2shell_move.xsl">
          <map:parameter name="sourceDir" value="{cmc2:gdir}/{global:ct}/inbox"/>
          <map:parameter name="targetDir" value="{cmc2:gdir}/{global:ct}/processed"/>
        </map:transform> 
        <map:transform type="shell"/>
        <map:serialize type="xml"/>
      </map:match>   
 
    </map:pipeline>
    
  </map:pipelines>
</map:sitemap>