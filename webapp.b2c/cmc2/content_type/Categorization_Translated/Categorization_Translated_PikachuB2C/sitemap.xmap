<?xml version="1.0" encoding="UTF-8"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">
	
	<map:pipelines>
		<map:component-configurations>
			<global-variables>
				<ct>Categorization_Translated</ct>
			</global-variables>
		</map:component-configurations>
		<map:pipeline type="noncaching">
     <!--+ 
       |
       |  Here is the main pipeline that executes the batch processing. 
       |  In invoking the pipeline the execution timestamp is passed as a parameter along with ct.
       |  Input parameters: {1} = timestamp
       |
       |  This sitemap differs from regular content type sitemaps because the content type has both
       |  an export and an import pipeline. Both are combined in one runMain pipeline that is triggered
       |  both by the needsprocessing_flag and by a file coming back from translation that needs to be imported. 
       |  
       +-->

		    <map:match pattern="runMain/*">        
		      <map:act type="copy-source" src="cocoon:/runMainExport/{1}">
		        <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/exportBatches_report.xml"/>
		      </map:act>
		      <map:act type="copy-source" src="cocoon:/runMainDirectImport/{1}">
		        <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/directImportBatches_report.xml"/>
		      </map:act>        
		      <map:act type="copy-source" src="cocoon:/runMainImport/{1}">
		        <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/importBatches_report.xml"/>
		      </map:act>
		      <map:aggregate element="reports">
		        <map:part src="{cmc2:gdir}/{global:ct}/temp/exportBatches_report.xml"/>
		        <map:part src="{cmc2:gdir}/{global:ct}/temp/directImportBatches_report.xml"/>          
		        <map:part src="{cmc2:gdir}/{global:ct}/temp/importBatches_report.xml"/>
		      </map:aggregate>
		      <map:serialize type="xml"/>   
		    </map:match>
    
			<!-- -->      
    
			<map:match pattern="runMainExport/*">
				<!-- prepare batches and write to file -->
				<map:act type="copy-source" src="cocoon:/PostProcess/batch/translation/processExportBatches/{global:ct}/{1}">
				<!--map:act type="copy-source" src="{cmc2:svcURL}/batch/translation/processExportBatches/{global:ct}/{1}"-->
					<map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/processExportBatches_report.xml"/>
				</map:act>				        
				<map:generate src="{cmc2:gdir}/{global:ct}/temp/processExportBatches_report.xml"/>
				<map:serialize type="xml"/>
			</map:match>
			<!-- -->            
			<map:match pattern="process/*_*/*/*/**">
				<map:generate src="{cmc2:xmlDir}/empty.xml"/>
		        <!-- create an entry record for the target octl -->
		        <map:transform src="{cmc2:xslDir}/common/create_entry_record.xsl">
		          <map:parameter name="o" value="{5}"/>
		          <map:parameter name="ct" value="{global:ct}"/>
		          <map:parameter name="l" value="{1}_{2}"/>
		          <map:parameter name="ts" value="{3}"/>
		        </map:transform>
		        <!-- include the content from the source octl -->
		        <map:transform src="xsl/include-content.xsl">
		          <map:parameter name="svcURL" value="{cmc2:svcURL}/"/>
		          <map:parameter name="o" value="{5}"/>
		          <map:parameter name="ct" value="Categorization_Raw"/>
		          <map:parameter name="l" value="none"/>
		        </map:transform>
		        <map:transform type="include"/>  
				<!-- the actual processing -->
		        <map:transform src="xsl/process_entries.xsl">
		          <map:parameter name="ct" value="Categorization_Raw"/>     
				</map:transform>
				<!--do we need to add category?-->
				<map:transform src="xsl/objectAttributes.xsl">
					<map:parameter name="category" value="{4}"/>       
				</map:transform>	
		        <map:serialize type="xml"/>
			</map:match>
    
			<!-- -->

			<map:match pattern="PostProcess/**">
				<map:generate src="{cmc2:svcURL}/{1}"/>
				<map:transform src="{cmc2:xslDir}/common/include_writeSource2process.xsl">
					<map:parameter name="process" value="cocoon:/PostProcessEntryFile"/>
				</map:transform>    
				<map:transform type="cinclude"/>
				<map:serialize type="xml"/>
			</map:match>
			<!-- -->	    
			<map:match pattern="PostProcessEntryFile/**">
			<!-- Called for export only -->
				<map:generate src="{1}"/>  
				<!-- do all post processing here -->
				<map:transform src="xsl/include-global.xsl">
					<map:parameter name="svcURL" value="{cmc2:svcURL}/"/>
					<map:parameter name="xmlDir" value="{cmc2:xmlDir}/"/>
					<map:parameter name="test" value="{1}/"/>
				</map:transform>		   
				<map:transform type="cinclude"/>		
				<map:transform src="xsl/formatTranslations.xsl"/>	  
				<map:transform src="xsl/clean.xsl"/>
			    <map:transform src="xsl/getRelatedLocalesForEntry.xsl"/>	
			  	<map:transform type="sql">
		  		<map:parameter name="use-connection" value="oracleDbCMC"/>
		  		<map:parameter name="clob-encoding" value="UTF-8"/>
			  	</map:transform>  				
			    <map:transform src="xsl/includeRelatedLocalesOnEntry.xsl"/>                     
				<!-- now save file -->
				<map:transform type="xslt-saxon" src="xsl/writeEntry.xsl">            
					<map:parameter name="dir" value="{cmc2:gdir}/{global:ct}"/>
					<map:parameter name="prefix" value="ex_"/>
				</map:transform>
				<map:transform type="write-source"/>		
				<map:transform src="xsl/include_writeSource2process.xsl">
					<map:parameter name="process" value="{cmc2:svcURL}/store/exportTranslationEntryFile"/>
          <map:parameter name="workflow" value="CL_CMC"/>
				</map:transform>
				<map:transform type="cinclude"/>				
				<map:serialize type="xml"/>
			</map:match> 
    
		    <!-- -->
        
			<map:match pattern="runMainDirectImport/*">
			    <map:act type="copy-source" src="cocoon:/DirectImport/batch/translation/processDirectBatches/{global:ct}/{1}/1"> 
			    <!--map:act type="copy-source" src="{cmc2:svcURL}/batch/translation/processDirectBatches/{global:ct}/{1}/1"-->          
					<map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/processDirectImportBatches_report.xml"/>
				</map:act>	        
				<map:generate src="{cmc2:gdir}/{global:ct}/temp/processDirectImportBatches_report.xml"/>				
				<map:serialize type="xml"/>	
			</map:match>        
      
		    <!-- -->            
    
			<map:match pattern="DirectImport/**">
				<map:generate src="{cmc2:svcURL}/{1}"/>
				<map:transform src="{cmc2:xslDir}/common/include_writeSource2process.xsl">
					<map:parameter name="process" value="cocoon:/DirectImportEntryFile"/>
				</map:transform>       
				<map:transform type="cinclude"/>
				<map:serialize type="xml"/>
			</map:match>
    
		    <!-- -->	    
    
		  <map:match pattern="DirectImportEntryFile/**">
				<map:generate src="{1}"/>
				<!-- do all post processing here -->
				<!-- NB no need for globals at this point in time -->
		        <map:transform src="xsl/clean.xsl"/>	
				<map:transform src="xsl/reformatForImport.xsl"/>
				<!-- now save file -->				
		        <map:transform type="xslt-saxon" src="{cmc2:xslDir}/common/writeEntry.xsl">
					<map:parameter name="dir" value="{cmc2:gdir}/{global:ct}"/>
					<map:parameter name="prefix" value="di_"/>
				</map:transform>				
				<map:transform type="write-source"/>		
				<map:transform src="{cmc2:xslDir}/common/include_writeSource2process.xsl">
					<map:parameter name="process" value="{cmc2:svcURL}/store/saveEntryFile"/>
				</map:transform>
				<map:transform type="cinclude"/>				
				<map:serialize type="xml"/>
			</map:match> 

			<!-- -->       
           
			<map:match pattern="runMainImport/*">
				<!--map:act type="copy-source" src="{cmc2:svcURL}/batch/translation/processImportBatches/{global:ct}/{1}"-->
				<map:act type="copy-source" src="{cmc2:svcURL}/store/importTranslation/batch/translation/processImportBatches/{global:ct}/{1}"> 
				  <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/processBatches_report.xml"/>
				</map:act>
				<map:act type="copy-source" src="{cmc2:svcURL}/processControl/archiveFiles/inbox/{global:ct}">
				  <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/archive_report.xml"/>
				</map:act>
				<map:generate src="{cmc2:gdir}/{global:ct}/temp/processBatches_report.xml"/>
				<map:serialize type="xml"/>
			</map:match>            
		</map:pipeline>
	</map:pipelines>
</map:sitemap>
