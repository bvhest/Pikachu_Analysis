<?xml version="1.0" encoding="UTF-8"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

  <map:resources>
    <!-- the sql resource provides a central place to edit database details -->
    <map:resource name="sql">
      <map:transform type="sql">
        <map:parameter name="use-connection" value="oracleDbCMC"/>
        <map:parameter name="clob-encoding" value="UTF-8"/>
      </map:transform>
    </map:resource>
  </map:resources>

  <map:pipelines>

    <map:component-configurations>
      <global-variables>
        <ct>catalog_log</ct>
      </global-variables>
    </map:component-configurations>

    <map:pipeline type="noncaching">


      <!-- Here is the main pipeline that exeutes the batch processing.
      In invoking the pipeline the execution timestamp is passed as a parameter along with ct.
        Input parameters: {1} = timestamp
        Output Document: Result of writing the report document to file
      -->
      <map:match pattern="runMain/*">
        <map:select type="parameter">
          <map:parameter name="parameter-selector-test" value="{request-param:runmode}"/>
          <map:when test="FASTLANE">
            <!-- FASTLANE RUN -->
            <map:act type="copy-source" src="{cmc2:svcURL}/batch/localised/createBatches/{global:ct}">
              <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/fastlane_createBatches_report.xml"/>
            </map:act>
            <map:act type="copy-source" src="{cmc2:svcURL}/store/save/batch/localised/processBatches/{global:ct}/{1}">
              <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/fastlane_processBatches_report.xml"/>
            </map:act>
            <map:aggregate element="reports">
              <map:part src="{cmc2:gdir}/{global:ct}/temp/fastlane_processBatches_report.xml"/>
            </map:aggregate>
          </map:when>
          <map:otherwise>
            <!-- BATCH RUN -->
	        <map:act type="copy-source" src="{cmc2:svcURL}/batch/localised/createBatches/{global:ct}">
	          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/first_pass_createBatches_report.xml"/>
	        </map:act>
	        <map:act type="copy-source" src="{cmc2:svcURL}/store/save/batch/localised/processBatches/{global:ct}/{1}">
	          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/first_pass_processBatches_report.xml"/>
	        </map:act>
	        <map:act type="copy-source" src="cocoon://cmc2/content_type/Catalog2SPOT?schedule_id=560">
	          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/first_pass_catalog_log_report.xml"/>
	        </map:act>        
	        <map:act type="copy-source" src="cocoon:/setNeedsProcessingFlags">
	          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/first_pass_setNeedsProcessingFlags_report.xml"/>
	        </map:act>       
	        <map:act type="copy-source" src="{cmc2:svcURL}/batch/localised/createBatches/{global:ct}">
	          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/second_pass_createBatches_report.xml"/>
	        </map:act>
	        <map:act type="copy-source" src="{cmc2:svcURL}/store/save/batch/localised/processBatches/{global:ct}/{1}?secondpass=true">
	          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/second_pass_processBatches_report.xml"/>
	        </map:act>
	        <map:act type="copy-source" src="cocoon://cmc2/content_type/Catalog2SPOT?schedule_id=560">
	          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/second_pass_catalog_log_report.xml"/>
	        </map:act>              
	        <map:act type="copy-source" src="cocoon:/setNeedsProcessingFlags">
	          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/second_pass_setNeedsProcessingFlags_report.xml"/>
	        </map:act>              
	        <map:aggregate element="reports">
	          <map:part src="{cmc2:gdir}/{global:ct}/temp/first_pass_processBatches_report.xml"/>
	          <map:part src="{cmc2:gdir}/{global:ct}/temp/second_pass_processBatches_report.xml"/>
	        </map:aggregate>
	      </map:otherwise>
	    </map:select>            
        <map:serialize type="xml"/>
      </map:match>

      <!-- {1} ts
         | {2} objectId 
         |-->
      <map:match pattern="process/none/*/**">
        <!-- get primary input -->
        <map:generate src="{cmc2:xmlDir}/empty.xml"/>
        <map:transform src="{cmc2:xslDir}/common/create_entry_record.xsl">
          <map:parameter name="o" value="{2}"/>
          <map:parameter name="ct" value="{global:ct}"/>
          <map:parameter name="l" value="none"/>
          <map:parameter name="ts" value="{1}"/>
        </map:transform>
        <!-- the actual processing -->
        <map:transform src="xsl/process_entries.xsl"/>
        <map:call resource="sql"/>
        <map:transform src="xsl/reformatProcessedRowsForStore.xsl">
          <map:parameter name="o" value="{2}"/>
          <map:parameter name="ct" value="{global:ct}"/>
          <map:parameter name="l" value="none"/>
          <map:parameter name="ts" value="{1}"/>
        </map:transform>
        <map:transform src="{cmc2:xslDir}/common/cleanup-sql-get.xsl"/>
        <map:serialize type="xml"/>
      </map:match>

      <map:match pattern="setNeedsProcessingFlags">
        <map:generate src="{cmc2:xmlDir}/empty.xml"/>
        <map:transform src="xsl/sql_setNeedsProcessingFlags.xsl">
          <map:parameter name="runmode" value="{request-param:runmode}"/>
        </map:transform>
        <map:call resource="sql"/>
        <map:serialize type="xml"/>
      </map:match>
      
    </map:pipeline>
  </map:pipelines>
</map:sitemap>
