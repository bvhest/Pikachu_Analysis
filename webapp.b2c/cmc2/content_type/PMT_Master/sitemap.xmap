<?xml version="1.0" encoding="UTF-8"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

  <map:components>
    <map:transformers default="xslt-saxon">
      <map:transformer name="romanization" src="org.apache.cocoon.transformation.RomanizationTransformer" />
    </map:transformers>
  </map:components>

  <map:resources>
    <map:resource name="sql">
      <map:transform type="sql">
        <map:parameter name="use-connection" value="oracleDbCMC"/>
        <map:parameter name="clob-encoding" value="UTF-8"/>
      </map:transform>
    </map:resource>
  </map:resources>

  <map:pipelines>

    <map:component-configurations>
      <global-variables>
        <ct>PMT_Master</ct>
      </global-variables>
    </map:component-configurations>

    <map:pipeline type="noncaching">
      <!-- Here is the main pipeline that executes the batch processing.
        In invoking the pipeline the execution timestamp is passed as a parameter along with ct.
        Input parameters: {1} = timestamp
        Output Document: ?
      -->
      <!-- -->
      <map:match pattern="runMain/*">
        <map:act type="copy-source" src="{cmc2:svcURL}/batch/localised/createBatches/{global:ct}">
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/createBatches_report.xml"/>
        </map:act>
        <map:act type="copy-source" src="{cmc2:svcURL}/batch/localised/processBatches/{global:ct}/{1}?storeURL={cmc2:svcURL}/store/deltaSaveSecEntryFile&amp;compareContent={cmc2:ctDir}/{global:ct}/xsl/compareContent.xsl">
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/processBatches_report.xml"/>
        </map:act>            
        <map:generate src="{cmc2:gdir}/{global:ct}/temp/processBatches_report.xml"/>
        <map:serialize type="xml"/>
      </map:match>
      <!--
         | TEST: http://localhost:8888/cmc2/content_type/PMT_Master/process/master_global/20111005121212/32PFL9705H/12      
         -->
      <map:match pattern="process/*/*/**">
      <!-- {1} localisation {2} timestamp {3} objectId -->
        <map:generate src="{cmc2:xmlDir}/empty.xml"/>
        <!-- create an entry record for the target octl -->
        <map:transform src="{cmc2:xslDir}/common/create_entry_record.xsl">
          <map:parameter name="o" value="{3}"/>
          <map:parameter name="ct" value="{global:ct}"/>
          <map:parameter name="l" value="{1}"/>
          <map:parameter name="ts" value="{2}"/>
          <map:parameter name="reload" value="{request-param:reload}"/>
          <map:parameter name="runmode" value="{request-param:runmode}"/>
        </map:transform>
        <map:call resource="sql"/>
        <!-- include the content from the source octl -->
        <map:transform src="xsl/include_content.xsl">
          <map:parameter name="svcURL" value="{cmc2:svcURL}/"/>
          <map:parameter name="o" value="{3}"/>
          <map:parameter name="ct" value="PMT_Enriched"/>
          <map:parameter name="l" value="master_global"/>
        </map:transform>
        <map:transform type="include"/>
        <!-- Fix Filter Feature codes -->
        <map:transform src="xsl/filterFix.xsl"/>
        <!-- the actual processing -->
        <map:transform src="xsl/process_entries.xsl">
          <map:parameter name="reload" value="{request-param:reload}"/>
        </map:transform>
        <!-- modified in the Obesitas project: 
             ObjectRelations are created in the PMT_Refs ct 
             and queried and included in the PMT_Master.
        -->
        <map:transform src="xsl/sql_objectRelations.xsl">
          <map:parameter name="ts" value="{2}"/>
          <map:parameter name="o" value="{3}"/>
        </map:transform>
        <map:call resource="sql"/>
        <map:transform src="xsl/convertObjectRelations.xsl"/>
        
        <!-- Process AssetList -->
        <map:transform src="xsl/assetList.xsl"/>
        <!-- Derive Secondaries-->
        <map:transform src="xsl/secondaryDerivation.xsl">
          <map:parameter name="svcURL" value="{cmc2:svcURL}/"/>
        </map:transform>
        <!-- Include ObjectAssetList content -->
        <map:transform type="cinclude"/>
        <!-- Convert OAL -->
        <map:transform src="xsl/convertObjectAssets.xsl"/>
        <!-- Include Range Text secondaries -->
        <map:transform src="{cmc2:xslDir}/common/get_secondaries.xsl">
          <map:parameter name="o" value="{3}"/>
          <map:parameter name="ct" value="{global:ct}"/>
          <map:parameter name="l" value="{1}"/>
        </map:transform>
        <map:call resource="sql"/>
        <map:transform src="{cmc2:xslDir}/common/include_secondaries.xsl">
          <map:parameter name="svcURL" value="{cmc2:svcURL}/"/>
        </map:transform>
        
        <map:transform type="cinclude"/>                        
        <map:transform src="xsl/processSecondaries.xsl"/>

        <map:transform src="xsl/seo.xsl"/>

        <map:transform type="romanization"/>
        <map:transform src="{cmc2:xslDir}/common/productAttributes.xsl"/>
        <map:serialize type="xml"/>
      </map:match>

    </map:pipeline>
  </map:pipelines>
</map:sitemap>