<?xml version="1.0" encoding="UTF-8"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">


  <map:components>

    <map:transformers default="xslt-saxon">
      <map:transformer name="romanization" src="org.apache.cocoon.transformation.RomanizationTransformer"/>
    </map:transformers>    

    <map:serializers>
      <map:serializer logger="sitemap.serializer.xml" mime-type="text/xml" name="xml-indented" src="org.apache.cocoon.serialization.XMLSerializer">
        <encoding>UTF-8</encoding>
        <indent>yes</indent>
      </map:serializer>
    </map:serializers>
  </map:components>

  <map:resources>
    <!-- the sql resource provides a central place to edit database details -->
    <map:resource name="sql">
      <map:transform type="sql">
        <map:parameter name="use-connection" value="oracleDbCMC"/>
        <map:parameter name="clob-encoding" value="UTF-8"/>
      </map:transform>
    </map:resource>
  </map:resources>

  <map:pipelines>
    <!-- -->
    <map:component-configurations>
      <global-variables>
        <ct>PMT</ct>
      </global-variables>
    </map:component-configurations>
    <!-- -->
    <map:pipeline type="noncaching">
      <!--
        Here is the main pipeline that executes the batch processing.
        In invoking the pipeline the execution timestamp is passed as a parameter along with ct.
        
        Input parameters:
         {1} = timestamp
        
        Request parameters:
         nosync - true: do not use the sync service.
         masterAssetsFrom - assetlist | masterdata (NOTE: param only used in Pikachu B2B!).
            assetlist:  master assets are retrieved from AssetList and ObjectAssetList content types.
            masterdata: master assets are retrieved from PMT_Master content types.
      -->
      <map:match pattern="runMain/*">
        <map:select type="resource-exists">
          <map:when test="{cmc2:gdir}/{global:ct}/inbox/reload.xml">
            <map:act type="copy-source" src="{cmc2:svcURL}/batch/sync/processBatches/{global:ct}/{1}?storeURL={cmc2:svcURL}/store/saveSecEntryFile&amp;reload=true">
              <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/processBatches_report.xml"/>
            </map:act>
            <map:act type="copy-source" src="{cmc2:svcURL}/processControl/archiveFiles/inbox/{global:ct}">
              <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/archive_report.xml"/>
            </map:act>
            <map:act type="copy-source" src="cocoon:/performanceStats/{1}">
              <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/performanceStats.xml"/>
            </map:act>            
          </map:when>
          <map:otherwise>
            <map:act type="copy-source" src="{cmc2:svcURL}/batch/sync/processBatches/{global:ct}/{1}?storeURL={cmc2:svcURL}/store/saveSecEntryFile">
              <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/processBatches_report.xml"/>
            </map:act>
            <map:act type="copy-source" src="cocoon:/performanceStats/{1}">
              <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/performanceStats.xml"/>
            </map:act>            
          </map:otherwise>
        </map:select>
        <map:aggregate element="reports">
          <map:part src="{cmc2:gdir}/{global:ct}/temp/processBatches_report.xml"/>
          <map:part src="{cmc2:gdir}/{global:ct}/temp/performanceStats.xml"/>
        </map:aggregate>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="performanceStats/*">
        <map:generate src="{cmc2:xmlDir}/empty.xml"/>
        <map:transform src="xsl/sql_getCounts.xsl">
          <map:parameter name="ts" value="{1}"/>
        </map:transform>        
        <map:call resource="sql"/>
        <map:transform src="xsl/performanceStats.xsl">
          <map:parameter name="ts" value="{1}"/>
        </map:transform>
        <map:serialize type="xml"/>
      </map:match>          

      <!--+
          | Called when synchronizing locales.
          | {1} content type
          | {2} input content type
          | {3} country code
          | {4} timestamp
          |
          | TEST: http://localhost:8888/cmc2/content_type/PMT/createEntryRecords/PMT/PMT_Translated/DE/20120514180000?batch_number=1
          +-->      
      <map:match pattern="createEntryRecords/*/*/*/*">
        <map:generate src="{cmc2:xmlDir}/empty.xml"/>
        <map:transform src="xsl/sql_select_entry_records.xsl">
          <map:parameter name="ct" value="{1}"/>
          <map:parameter name="input_ct" value="{2}"/>
          <map:parameter name="country_code" value="{3}"/>
          <map:parameter name="ts" value="{4}"/>
          <map:parameter name="reload" value="{request-param:reload}"/>
          <map:parameter name="batch_number" value="{request-param:batch_number}"/>
          <map:parameter name="nosync" value="{request-param:nosync}"/>
          <map:parameter name="runmode" value="{request-param:runmode}"/>
        </map:transform>
        <map:call resource="sql"/>
        <!-- get the content for the primary inputs -->                
        <map:transform src="xsl/sql_getPrimaryInputContent.xsl">
          <map:parameter name="ctURL" value="{cmc2:ctURL}/"/>
          <!--map:parameter name="ct" value="{1}"/-->
          <map:parameter name="ct" value="PMT_Translated"/>
          <map:parameter name="ts" value="{4}"/>
          <map:parameter name="master-assets-from" value="{request-param:masterAssetsFrom}"/>
          <map:parameter name="runmode" value="{request-param:runmode}"/>
          <map:parameter name="reload" value="{request-param:reload}"/>
        </map:transform>
        <map:call resource="sql"/>
        
        <map:transform src="xsl/create_entry_record.xsl">
          <map:parameter name="ctURL" value="{cmc2:ctURL}/"/>
          <map:parameter name="xslDir" value="{cmc2:xslDir}/"/>
          <map:parameter name="ct" value="{1}"/>
          <map:parameter name="ts" value="{4}"/>
          <map:parameter name="master-assets-from" value="{request-param:masterAssetsFrom}"/>
          <map:parameter name="runmode" value="{request-param:runmode}"/>
          <map:parameter name="reload" value="{request-param:reload}"/>
        </map:transform>        

        <!-- Text Localizer  -->
        <map:transform src="xsl/localizer_convertor.xsl"/>
        
        <!-- Convert to correct xUCDM format -->        
        <map:transform src="xsl/convertProducts.xsl">
          <map:parameter name="master-assets-from" value="{request-param:masterAssetsFrom}"/>
        </map:transform> 
        
        <!-- Assets Localizer  -->
        <map:transform src="xsl/assets_localizer_prepare.xsl">
          <map:parameter name="doctypeconfig" value="{cmc2:xmlDir}/doctype_attributes.xml"/>
        </map:transform>
        <map:transform src="xsl/assets_localizer_convertor.xsl"/>
                
        <map:transform src="xsl/filterFix.xsl"/>
        <map:transform src="{cmc2:xslDir}/common/escape_sql_ns.xsl"/>

        <!-- Include ObjectAssetList and RangeText secondaries --> 
        <map:transform src="xsl/sql_include_secondary_content.xsl">
          <map:parameter name="includesec" value="{request-param:includesec}"/>
          <map:parameter name="master-assets-from" value="{request-param:masterAssetsFrom}"/>
        </map:transform>        
        <map:call resource="sql"/>
        <map:transform src="xsl/mergeAwards.xsl"/>
        <map:transform src="{cmc2:xslDir}/common/escape_sql_ns.xsl"/>

        <map:transform src="xsl/sql_include_secondary_assets.xsl">
          <map:parameter name="includesec" value="{request-param:includesec}"/>
          <map:parameter name="master-assets-from" value="{request-param:masterAssetsFrom}"/>
        </map:transform>        
        <map:call resource="sql"/>
        <map:transform src="{cmc2:xslDir}/common/escape_sql_ns.xsl"/>

        <map:transform src="xsl/convertSecondaryContent.xsl"/>
        <!-- Add asset captions -->
        <map:transform src="xsl/assetCaptions.xsl"/>

        <map:transform src="{cmc2:xslDir}/common/restore_sql_ns.xsl"/>
        
        <!-- Transform for SEO -->
        <map:transform src="xsl/seo.xsl"/>
        <!-- and replace the non-latin characters -->
        <map:transform type="romanization"/>

        <!-- The normal processing -->
        <map:transform src="xsl/process_entries.xsl">
          <map:parameter name="reload" value="{request-param:reload}"/>
        </map:transform>
        <map:transform src="{cmc2:xslDir}/common/productAttributes.xsl"/>
        <map:transform src="xsl/sql_getRichTextSecondaries.xsl"/>        
        <map:call resource="sql"/>                        
        <map:transform src="xsl/secondaryDerivation.xsl"/>                
        <map:transform src="{cmc2:xslDir}/common/cleanup-sql.xsl"/>

        <map:transform src="{cmc2:xslDir}/common/writeEntry.xsl">
          <map:parameter name="dir" value="{cmc2:gdir}/{1}"/>
          <map:parameter name="prefix" value="{3}_"/>
        </map:transform>

        <map:transform type="write-source"/>
        <map:serialize type="xml"/>
      </map:match>
    </map:pipeline>
  </map:pipelines>
</map:sitemap>
