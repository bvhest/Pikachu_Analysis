<?xml version="1.0" encoding="UTF-8"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

  <map:resources>
    <!-- the sql resource provides a central place to edit database details -->
    <map:resource name="sql">
      <map:transform type="sql">
        <map:parameter name="use-connection" value="oracleDbCMC"/>
        <map:parameter name="clob-encoding" value="UTF-8"/>
      </map:transform>
    </map:resource>
  </map:resources>

  <map:pipelines>

    <map:component-configurations>
      <global-variables>
        <ct>Categorization_Raw</ct>
      </global-variables>
    </map:component-configurations>

    <map:pipeline type="noncaching">
      <!-- Here is the main pipeline that executes the batch processing.
      In invoking the pipeline the execution timestamp is passed as a parameter along with ct.
        Input parameters: {1} = timestamp
        Output Document: Result of writing the report document to file
      -->
      <map:match pattern="runMain/*">
    
         <map:act type="copy-source" src="cocoon:/pre-processInbox">
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/pre-processInbox_report.xml"/>
        </map:act>     
        
        <map:act type="copy-source" src="{cmc2:svcURL}/store/importExec/batch/import/processFiles/{global:ct}/{1}">
        <!--map:act type="copy-source" src="{cmc2:svcURL}/batch/import/processFiles/{global:ct}/{1}"-->
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/processFiles_report.xml"/>
        </map:act>
        <map:act type="copy-source" src="{cmc2:svcURL}/processControl/archiveFiles/inbox/{global:ct}">
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/archive_report.xml"/>
        </map:act>
        <map:generate src="{cmc2:gdir}/{global:ct}/temp/processFiles_report.xml"/>
        <map:serialize type="xml"/>
      </map:match>
      
      <map:match pattern="pre-processInbox">
        <map:generate type="directory" src="{cmc2:gdir}/{global:ct}/inbox">
          <map:parameter name="depth" value="1"/>
          <map:parameter name="include" value=".*\.xml"/>
        </map:generate>
        <map:transform type="xslt-saxon" src="xsl/include2transformXML.xsl"/>
        <map:transform type="cinclude"/>
        <map:serialize type="xml"/>
      </map:match>
      
      <map:match pattern="transformFile/*">
       <map:act type="copy-source" src="cocoon:/convertTree/{1}">
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/inbox/batch_{1}"/>
        </map:act>      
        <map:act type="copy-source" src="cocoon:/archiveFile/{1}">
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/archiveReport.xml"/>
        </map:act>     
        <map:generate src="{cmc2:gdir}/{global:ct}/temp/archiveReport.xml"/>
        <map:serialize type="xml"/>
      </map:match>  
      
       <map:match pattern="convertTree/*">
        <map:generate src="{cmc2:gdir}/{global:ct}/inbox/{1}"/>
        <map:transform type="xslt-saxon" src="xsl/convertTree.xsl"/>
         <map:transform type="xslt-saxon" src="xsl/addDummyLevels.xsl"/>
        <map:serialize type="xml"/>
      </map:match>  
      
     <map:match pattern="archiveFile/*">
        <map:generate src="{cmc2:xmlDir}/empty.xml"/>
        <map:transform type="xslt-saxon" src="xsl/archiveFile.xsl">
          <map:parameter name="sourceFile" value="{1}"/>
          <map:parameter name="sourceDir" value="{cmc2:gdir}/{global:ct}/inbox"/>
          <map:parameter name="targetDir" value="{cmc2:gdir}/{global:ct}/processed"/>
        </map:transform>
        <map:transform type="shell"/>
        <map:serialize type="xml"/>
      </map:match>      
      
    </map:pipeline>
  </map:pipelines>
</map:sitemap>
