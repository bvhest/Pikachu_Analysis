<?xml version="1.0" encoding="UTF-8"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

  <map:resources>
    <!-- the sql resource provides a central place to edit database details -->
    <map:resource name="sql">
      <map:transform type="sql">
        <map:parameter name="use-connection" value="oracleDbCMC"/>
        <map:parameter name="clob-encoding" value="UTF-8"/>
      </map:transform>
    </map:resource>
  </map:resources>
  <!-- -->  
  <map:components>  
    <map:transformers default="xslt-saxon">
      <map:transformer name="sendmail" src="org.apache.cocoon.mail.transformation.SendMailTransformer">
        <smtphost>nlvg020.gdc1.ce.philips.com</smtphost>
        <smtpport>25</smtpport>
      </map:transformer> 
    </map:transformers>
  </map:components>  
  <!-- -->      
  <map:pipelines>
    <map:component-configurations>
      <global-variables>
        <ct>RefreshMV</ct>
        <MVCount>8</MVCount>
      </global-variables>
    </map:component-configurations>

    <map:pipeline type="noncaching">

      <!--
          Insert into CONTENT_TYPES (CONTENT_TYPE, REFERENCE_NAME, DISPLAY_NAME, SECONDARY_DERIVATION, DESCRIPTION, MACHINEAFFINITY, ID, PIPELINE)
          Values ('RefreshMV', 'RefreshMV', 'RefreshMV', 0, 'RefreshMV', '', '', '');
          Insert into CONTENT_TYPE_SCHEDULE  (ID, CONTENT_TYPE, STARTEXEC, ENDEXEC, MACHINEAFFINITY, PIPELINE, DESCRIPTION)
           Values  ('795', 'RefreshMV', null, null, 'all(SAT)(SUN)(MON)(TUE)(WED)(THU)(FRI)', 'cmc2/content_type/RefreshMV', 'Refresh Materialized Views');
        -->

      <!-- Here is the main pipeline that exeutes the batch processing.
      In invoking the pipeline the execution timestamp is passed as a parameter along with ct.
        Input parameters: {1} = timestamp
        Output Document: Result of writing the report document to file
      -->
      <map:match pattern="runMain/*">
        <map:act type="copy-source" src="cocoon:/refreshMV/{1}">
          <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/refreshMVReport.xml"/>
        </map:act>
        <map:generate src="{cmc2:gdir}/{global:ct}/temp/refreshMVReport.xml"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->  
      <map:match pattern="refreshMV/*">
          <!-- {1} = timestamp -->
          <map:generate src="{cmc2:xmlDir}/empty.xml"/>
          <map:transform src="xsl/sql_refreshMV.xsl">
            <map:parameter name="ct" value="{global:ct}"/>
            <map:parameter name="l" value="none"/>
            <map:parameter name="ts" value="{1}"/>
            <map:parameter name="view-name" value="{request-param:view}"/>
          </map:transform>
          <map:call resource="sql"/>
          <map:transform src="xsl/sql_checkRefreshTimes.xsl">
            <map:parameter name="view-name" value="{request-param:view}"/>
          </map:transform>          
          <map:call resource="sql"/>                  
          <map:transform src="xsl/formatWarningEmail.xsl">
            <!-- number of expected materialized views -->
            <map:parameter name="mv_count" value="{global:MVCount}"/>
            <map:parameter name="timestamp" value="{date:yyyy-MM-dd}T{date:HH:mm:ss}"/>                
            <map:parameter name="server" value="{cmc2:cocoonServer}"/>
            <map:parameter name="sender" value="{cmc2:emailSender}"/>
            <map:parameter name="recipient" value="{cmc2:emailRecipient}"/>        
            <map:parameter name="view-name" value="{request-param:view}"/>
          </map:transform>                
          <map:transform type="sendmail"/>	                  
          <map:serialize type="xml"/>
      </map:match>
    </map:pipeline>
  </map:pipelines>
</map:sitemap>
