<?xml version="1.0" encoding="UTF-8"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">
  <map:resources>
    <!-- the sql resource provides a central place to edit database details -->
    <map:resource name="sql">
      <map:transform type="sql">
        <map:parameter name="use-connection" value="oracleDbCMC"/>
        <map:parameter name="clob-encoding" value="UTF-8"/>
      </map:transform>
    </map:resource>
  </map:resources>
  <!-- -->  
  <map:pipelines>

    <map:component-configurations>
      <global-variables>
        <ct>PP_Log</ct>
      </global-variables>
    </map:component-configurations>
  
    <map:pipeline type="noncaching">
      <!-- Here is the main pipeline that executes the batch processing. 
        In invoking the pipeline the execution timestamp is passed as a parameter along with ct.
        Input parameters: {1} = timestamp
      -->
         <map:match pattern="runMain/*">    
            <map:act type="copy-source" src="{cmc2:svcURL}/batch/localised/createBatches/{global:ct}/none">       
               <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/createBatches_report.xml"/>
            </map:act>  
            <map:act type="copy-source" src="{cmc2:svcURL}/store/save/batch/localised/processBatches/{global:ct}/none/{1}">
               <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/processBatches_report.xml"/>
            </map:act>                
            <map:generate src="{cmc2:gdir}/{global:ct}/temp/processBatches_report.xml"/>
            <map:serialize type="xml"/>
         </map:match>


         <!-- per-entry processing 
            |
            | TEST: http://localhost:8888/cmc2/content_type/PP_Log/process/none/20130204112233/PP_HTS7202_12_20130204113318
            |-->
         <map:match pattern="process/*/*/**">
            <!-- {1} localisation {2} timestamp {3} objectId -->      
            <map:generate src="{cmc2:xmlDir}/empty.xml"/>
            <!-- create an entry record for the target octl -->
            <map:transform src="{cmc2:xslDir}/common/create_entry_record.xsl">
               <map:parameter name="o" value="{3}"/>
               <map:parameter name="ct" value="{global:ct}"/>
               <map:parameter name="l" value="{1}"/>
               <map:parameter name="ts" value="{2}"/>
            </map:transform>
            <!-- include the content from the source octl -->
            <map:transform src="xsl/include_content.xsl">
               <map:parameter name="svcURL" value="{cmc2:svcURL}/"/>
               <map:parameter name="o" value="{3}"/>
               <map:parameter name="ct" value="PP_Configuration"/>
               <map:parameter name="l" value="{1}"/>
            </map:transform>
<!-- DEBUG BHE 
<map:serialize type="xml"/>         
-->
            <map:transform type="cinclude"/>  
            <map:transform src="xsl/process_entries.xsl"/>

            <!-- derive secondaries-->
            <map:transform src="xsl/secondaryDerivation.xsl">
               <map:parameter name="o" value="{3}"/>
            </map:transform>
            <!-- create relations to secondaries-->
            <map:transform src="{cmc2:xslDir}/common/placeholders_relations.xsl"/>
            <map:call resource="sql"/>
<!-- DEBUG BHE 
<map:serialize type="xml"/>         
-->
            <!-- invalidate octl if secondary relations can not be created-->
            <map:transform src="{cmc2:xslDir}/common/validate_store_outputs.xsl"/>
            <map:transform src="{cmc2:xslDir}/common/cleanup-sql.xsl"/>
<!-- DEBUG BHE 
<map:serialize type="xml"/>         
-->
            <map:serialize type="xml"/>
         </map:match>
    </map:pipeline>
  </map:pipelines>
</map:sitemap>
