<?xml version="1.0" encoding="UTF-8"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

  <map:components>
    <map:transformers>
      <map:transformer name="sendmail" src="org.apache.cocoon.mail.transformation.SendMailTransformer">
        <smtphost>nlvg020.gdc1.ce.philips.com</smtphost>
        <smtpport>25</smtpport>
      </map:transformer>
    </map:transformers>
    <map:selectors>
      <map:selector name="parameter" logger="sitemap.selector.parameter" src="org.apache.cocoon.selection.ParameterSelector"/>
    </map:selectors>
  </map:components>

  <map:pipelines>
    <map:component-configurations>
      <global-variables>
        <ct>RangeText_Translated</ct>
      </global-variables>
    </map:component-configurations>
    <map:pipeline type="noncaching">
     <!--+
         |
         |  Here is the main pipeline that executes the batch processing.
         |  In invoking the pipeline the execution timestamp is passed as a parameter along with ct.
         |  Input parameters: {1} = timestamp
         |
         |  This sitemap differs from regular content type sitemaps because the content type has both
         |  an export and an import pipeline. Both are combined in one runMain pipeline that is triggered
         |  both by the needsprocessing_flag and by a file coming back from translation that needs to be imported.
         |
         +-->

    <map:match pattern="runMain/*">
      <map:act type="copy-source" src="cocoon:/runMainExport/{1}">
        <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/exportBatches_report.xml"/>
      </map:act>
      <map:act type="copy-source" src="cocoon:/runMainImport/{1}">
        <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/importBatches_report.xml"/>
      </map:act>
      <map:act type="copy-source" src="cocoon:/runMainDirectImport/{1}">
        <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/directImportBatches_report.xml"/>
      </map:act>
      <map:aggregate element="reports">
        <map:part src="{cmc2:gdir}/{global:ct}/temp/exportBatches_report.xml"/>
        <map:part src="{cmc2:gdir}/{global:ct}/temp/importBatches_report.xml"/>
        <map:part src="{cmc2:gdir}/{global:ct}/temp/directImportBatches_report.xml"/>
      </map:aggregate>
      <map:serialize type="xml"/>
    </map:match>

    <!-- -->

    <map:match pattern="runMainExport/*">
      <map:act type="copy-source" src="{cmc2:svcURL}/batch/translation/createExportBatches/{global:ct}/{1}">
        <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/createExportBatches_report.xml"/>
      </map:act>
      <map:act type="copy-source" src="cocoon:/PostProcess/batch/translation/processExportBatches/{global:ct}/{1}">
      <!--map:act type="copy-source" src="{cmc2:svcURL}/batch/translation/processExportBatches/{global:ct}/{1}"-->
        <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/processExportBatches_report.xml"/>
      </map:act>
      <map:aggregate element="reports">
        <map:part src="{cmc2:gdir}/{global:ct}/temp/createExportBatches_report.xml"/>
        <map:part src="{cmc2:gdir}/{global:ct}/temp/processExportBatches_report.xml"/>
      </map:aggregate>
      <map:serialize type="xml"/>
    </map:match>

    <!-- -->

    <map:match pattern="PostProcess/**">
      <map:generate src="{cmc2:svcURL}/{1}"/>
      <map:transform src="{cmc2:xslDir}/common/include_writeSource2process.xsl">
        <map:parameter name="process" value="cocoon:/PostProcessEntryFile"/>
      </map:transform>
      <map:transform type="cinclude"/>
      <map:serialize type="xml"/>
    </map:match>

    <!-- -->

    <map:match pattern="PostProcessEntryFile/**">
      <map:generate src="{1}"/>
      <!-- do all post processing here -->
      <map:transform src="xsl/include_global.xsl">
        <map:parameter name="svcURL" value="{cmc2:svcURL}/"/>
        <map:parameter name="xmlDir" value="{cmc2:xmlDir}/"/>
        <map:parameter name="test" value="{1}/"/>
      </map:transform>
      <map:transform type="cinclude"/>
      <map:transform src="xsl/formatTranslations.xsl"/>
      <map:transform src="xsl/clean.xsl"/>
      <map:transform src="xsl/getRelatedLocalesForEntry.xsl">
        <!-- runcatalogexport will only have a value in the case of a catalog.xml request -->
        <map:parameter name="runcatalogexport" value="{request-param:runcatalogexport}"/>
      </map:transform>
      <map:transform type="sql">
        <map:parameter name="use-connection" value="oracleDbCMC"/>
        <map:parameter name="clob-encoding" value="UTF-8"/>
      </map:transform>
      <map:transform src="xsl/includeRelatedLocalesOnEntry.xsl"/>
      <map:transform src="xsl/batchProducts.xsl">
        <map:parameter name="dir" value="{cmc2:gdir}/{global:ct}/temp/"/>
        <map:parameter name="tempdir" value="{cmc2:gdir}/{global:ct}/temp/"/>
        <map:parameter name="maxcount" value="20000"/>
        <map:parameter name="runcatalogexport" value="{request-param:runcatalogexport}"/>
        <map:parameter name="catalogfiledir"  value="{cmc2:gdir}/{global:ct}/inbox"/>
      </map:transform>
      <!-- now save file -->
      <map:transform type="xslt-saxon" src="xsl/writeEntry.xsl">
        <map:parameter name="dir" value="{cmc2:gdir}/{global:ct}"/>
        <map:parameter name="prefix" value="ex_"/>
      </map:transform>
      <map:transform type="write-source"/>
      <map:transform src="xsl/include_writeSource2process.xsl">
        <map:parameter name="process" value="{cmc2:svcURL}/store/exportTranslationEntryFile"/>
        <map:parameter name="runcatalogexport" value="{request-param:runcatalogexport}"/>
        <map:parameter name="workflow" value="CL_CMC"/>
      </map:transform>
      <map:transform type="cinclude"/>
      <map:serialize type="xml"/>
    </map:match>

    <!-- -->

    <map:match pattern="runMainDirectImport/*">
      <map:act type="copy-source" src="cocoon:/DirectImport/batch/translation/processDirectBatches/{global:ct}/{1}/1">
        <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/processDirectImportBatches_report.xml"/>
      </map:act>
      <map:generate src="{cmc2:gdir}/{global:ct}/temp/processDirectImportBatches_report.xml"/>
      <map:serialize type="xml"/>
    </map:match>

    <!-- -->

    <map:match pattern="DirectImport/**">
      <map:generate src="{cmc2:svcURL}/{1}"/>
      <map:transform src="{cmc2:xslDir}/common/include_writeSource2process.xsl">
        <map:parameter name="process" value="cocoon:/DirectImportEntryFile"/>
      </map:transform>
      <map:transform type="cinclude"/>
      <map:serialize type="xml"/>
    </map:match>

    <!-- -->

    <map:match pattern="DirectImportEntryFile/**">
      <map:generate src="{1}"/>
      <!-- Do all post processing here -->
      <map:transform src="xsl/clean.xsl"/>
      <map:transform src="xsl/reformatForImport.xsl"/>
      <!-- now save file -->
      <map:transform type="xslt-saxon" src="{cmc2:xslDir}/common/writeEntry.xsl">
        <map:parameter name="dir" value="{cmc2:gdir}/{global:ct}"/>
        <map:parameter name="prefix" value="di_"/>
      </map:transform>
      <map:transform type="write-source"/>
      <map:transform src="{cmc2:xslDir}/common/include_writeSource2process.xsl">
        <map:parameter name="process" value="{cmc2:svcURL}/store/saveEntryFile"/>
      </map:transform>
      <map:transform type="cinclude"/>
      <map:serialize type="xml"/>
    </map:match>

    <!-- -->

    <map:match pattern="runMainImport/*">
      <map:act type="copy-source" src="{cmc2:svcURL}/store/importTranslation/batch/translation/processImportBatches/{global:ct}/{1}">
        <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/processImportBatches_report.xml"/>
      </map:act>
      <map:act type="copy-source" src="cocoon:/generateErrorsEmail">
        <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/ErrorsReport.xml"/>
      </map:act>
      <map:act type="copy-source" src="cocoon:/archiveFiles/{1}">
        <map:parameter name="dest" value="{cmc2:gdir}/{global:ct}/temp/archive_report.xml"/>
      </map:act>      
      <map:generate src="{cmc2:gdir}/{global:ct}/temp/processImportBatches_report.xml"/>
      <map:serialize type="xml"/>
    </map:match>

    <!-- -->

    <map:match pattern="generateErrorsEmail">
      <map:generate type="xpathdirectory" src="{cmc2:gdir}/{global:ct}/temp" label="step1">
        <map:parameter name="xpath" value="/entries/entry[result/error]"/>
        <map:parameter name="xmlFiles" value="^im.*\.xml"/>
        <map:parameter name="include" value="^im_.*"/>
      </map:generate>
      <map:transform type="xslt-saxon" src="xsl/generateErrorsEmail.xsl">
        <map:parameter name="server" value="{cmc2:cocoonServer}"/>
        <map:parameter name="sender" value="{cmc2:emailSender}"/>
        <map:parameter name="recipient" value="{cmc2:emailSender}"/>
      </map:transform>
      <map:transform type="sendmail"/>
      <map:serialize type="xml"/>
    </map:match>

    <!-- -->
    
    <map:match pattern="archiveFiles/*">
      <!-- Archive only catalog.xml files with ts earlier than runts, and files processed by the import (i.e. in processImportBatches_report.xml) -->
      <map:generate type="directory" src="{cmc2:gdir}/{global:ct}/inbox">
        <map:parameter name="depth" value="1"/>
        <map:parameter name="include" value=".*\.xml"/>
        <map:parameter name="dateFormat" value="yyyy-MM-dd HH:mm"/>
      </map:generate>
      <map:transform type="xslt-saxon" src="{cmc2:xslDir}/common/generateArchiveFileList.xsl">
        <map:parameter name="processFilePath" value="{cmc2:gdir}/{global:ct}/temp/processImportBatches_report.xml"/>
        <map:parameter name="ts" value="{1}"/>
        <map:parameter name="ct" value="{global:ct}"/>
        <map:parameter name="sourceDir" value="{cmc2:gdir}/{global:ct}/inbox"/>
        <map:parameter name="targetDir" value="{cmc2:gdir}/{global:ct}/processed"/>
      </map:transform>
      <map:transform type="shell"/>
      <map:serialize type="xml"/>
    </map:match>    

    <!-- -->    

    <map:match pattern="process/*_*/*/*/**">
    <!-- {1} and {2} localisation {3} timestamp {4} category {5} objectId -->
      <map:generate src="{cmc2:xmlDir}/empty.xml"/>
      <map:transform type="xslt-saxon" src="xsl/create_entry_record.xsl">
        <map:parameter name="ct_in" value="RangeText_Localized"/>
        <map:parameter name="ct_out" value="{global:ct}"/>
        <map:parameter name="l_in" value="master_{2}"/>
        <map:parameter name="l_out" value="{1}_{2}"/>
        <map:parameter name="ts" value="{3}"/>
        <map:parameter name="category" value="{4}"/>
        <map:parameter name="o" value="{5}"/>
        <map:parameter name="svcURL" value="{cmc2:svcURL}/"/>
    </map:transform>
    <!-- Execute the include -->
    <map:transform type="include"/>
    <!-- Clean content and set octl-attributes elements -->
    <map:transform src="xsl/process_entries.xsl"/>
    <map:transform type="sql">
      <map:parameter name="use-connection" value="oracleDbCMC"/>
      <map:parameter name="clob-encoding" value="UTF-8"/>
    </map:transform>
    <map:transform src="xsl/create_routing_code.xsl"/>
    <!-- Swap octl-attributes timestamps into Product attributes -->
    <map:transform type="xslt-saxon" src="{cmc2:xslDir}/common/productAttributes.xsl"/>
    <map:serialize type="xml"/>
    </map:match>

    <!-- -->

    </map:pipeline>
  </map:pipelines>
</map:sitemap>
