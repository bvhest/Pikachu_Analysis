<?xml version="1.0"?>
  <!--
    Copyright 1999-2004 The Apache Software Foundation Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License. You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0 Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
    either express or implied. See the License for the specific language governing permissions and limitations under the
    License.
  -->

<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

  <!-- =========================== Components ================================ -->

  <map:components>
    <!-- HTML that doesn't output doctype info -->
    <map:serializers>
      <map:serializer logger="sitemap.serializer.html" mime-type="text/html" name="barehtml" pool-max="${html-serializer.pool-max}" src="org.apache.cocoon.serialization.HTMLSerializer">
        <encoding>UTF-8</encoding>
        <standalone>yes</standalone>
        <indent>yes</indent>
        <omit-xml-declaration>yes</omit-xml-declaration>
      </map:serializer>
    </map:serializers>

    <map:readers default="resource">
      <!-- Defines a SOAP RPC reader that will serve SOAP requests via HTTP-POST. -->
      <map:reader logger="sitemap.reader.soap-rpc" name="soap-rpc" src="org.apache.cocoon.reading.AxisRPCReader" />
    </map:readers>
  </map:components>

  <!-- =========================== Resources ================================= -->

  <map:resources>
    <map:resource name="sql">
      <map:transform type="sql">
        <map:parameter name="use-connection" value="oracleDbCMC"/>
        <map:parameter name="clob-encoding" value="UTF-8"/>
        <map:parameter name="show-nr-of-rows" value="true"/>
      </map:transform>
    </map:resource>
  </map:resources>

  <!-- =========================== Pipelines ================================= -->

  <map:pipelines>
    <!-- sub-sitemap soap example pipeline -->
    <map:pipeline>
      <!-- Match SOAP RPC Router request with additional path to indicate the target service -->
      <map:match pattern="call/*">
        <map:read type="soap-rpc" mime-type="text/xml">
          <in-development-stage>false</in-development-stage>
        </map:read>
      </map:match>

      <!-- Send all non qualified requests to the status page -->
      <map:match pattern="">
        <map:redirect-to uri="status.xsp" />
      </map:match>

      <map:match pattern="status.xsp">
        <map:generate type="serverpages" src="status.xsp" />
        <map:transform src="status.xsl" />
        <map:serialize type="html" />
      </map:match>
      
      <!--
         | ICP call from Empower.me
         | {1} = content type
         | {2} = locale
         | {3} = id
         |
         | E.g. /webservice/soap/icp/PMT/nl_NL/56PFL9954H/12 -->
      <map:match pattern="icp/*/*/**">
        <map:select type="resource-exists">
          <map:when test="../../../cmc2xucdm/ct/{1}.xsl">
            <!-- map:generate src="{cmc2:svcUrl}/common/getcontent/{1}/{2}/{3}"/ 
            <map:generate src="cocoon://cmc2/webservice/pipelines/getObjectDocument?contentType={1}&amp;locale={2}&amp;objectID={3}&amp;username={request:userPrincipal/name}&amp;target=icp"/>
            
            <map:generate src="cocoon://cmc2/webservice/pipelines/getObjectDocument?contentType={1}&amp;locale={2}&amp;objectID={3}&amp;target=icp"/>
            -->                                                                                    
            <map:generate src="cocoon://cmc2/service/common/get-octl/{1}/{2}/{3}"/>           
            <map:transform type="xslt-saxon" src="icp/prepare.xsl"/>
            <!-- Transform to create the preview -->
            
            <map:transform type="xslt-saxon" src="../../../cmc2xucdm/ct/{1}.xsl"/>            
          </map:when>
          <map:otherwise>
            <map:generate src="nopreview.xml" />
          </map:otherwise>
        </map:select>
        <map:serialize type="barehtml" />
      </map:match>

    </map:pipeline>
  </map:pipelines>

</map:sitemap>

  <!-- end of file -->

