<?xml version="1.0" encoding="UTF-8"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

    <!-- GLOBAL variables
          {cmc2:gdir}      This is the top level of the data directory struture. Each ct has its own "archive","inbox","outbox","temp" and "log" sub-directories
          {cmc2:xmlDir}    This is the directory containing common xml documents
          {cmc2:xslDir}    this directory contains "common" and "ct" specific xslt transform documents
    -->

  <map:resources>
    <!-- the sql resource provides a central place to edit database details -->
    <map:resource name="sql">
      <map:transform type="sql">
        <map:parameter name="use-connection" value="oracleDbCMC"/>
        <map:parameter name="clob-encoding" value="UTF-8"/>
      </map:transform>
    </map:resource>
  </map:resources>

  <map:pipelines>
    <map:pipeline type="noncaching">


     <!-- Group items based on country
	        Input parameters: {1} = ct  {2} = ts
	        Output Document: Result of writing the report document to file
	  -->
      <map:match pattern="processBatches/*/*">
        <map:generate src="{cmc2:xmlDir}/empty.xml"/>     
        <map:transform type="xslt-saxon" src="xsl/sql_selectbatches.xsl">
          <map:parameter name="runmode" value="{request-param:runmode}"/>
          <map:parameter name="ct" value="{1}"/>
          <map:parameter name="reload" value="{request-param:reload}"/>
        </map:transform>        
        <map:call resource="sql"/>
        <map:select type="parameter">
          <map:parameter name="parameter-selector-test" value="{1}"/>
          <map:when test="PMT">
            <!-- Create sub-batches per country -->
            <map:transform type="xslt-saxon" src="xsl/include_ctl2createSubBatchesForCountry.xsl">
              <map:parameter name="timestamp" value="{2}"/>
            </map:transform>
          </map:when>            
          <map:otherwise>        
            <map:transform type="xslt-saxon" src="xsl/include_ctl2createEntryRecords.xsl">
              <map:parameter name="timestamp" value="{2}"/>
            </map:transform>
          </map:otherwise>        
        </map:select>        
        <map:transform type="cinclude"/>
        <map:serialize type="xml"/>
      </map:match>
      <!--
        {1} ct
        {2} input_ct
        {3} country
        {4} timestamp 
      -->
      <map:match pattern="createSubBatchesForCountry/*/*/*/*">
        <map:generate src="{cmc2:xmlDir}/empty.xml"/>     
        <map:transform type="xslt-saxon" src="xsl/sql_createSubBatchesForCountry.xsl">
          <map:parameter name="runmode" value="{request-param:runmode}"/>
          <map:parameter name="ct" value="{1}"/>
          <map:parameter name="country" value="{3}"/>          
          <map:parameter name="batchsize" value="50"/> 
          <map:parameter name="reload" value="{request-param:reload}"/>
          <map:parameter name="schedule_id" value="{request-param:schedule_id}"/>
          <map:parameter name="run_id" value="{request-param:runId}"/>
        </map:transform>
        <map:call resource="sql"/>
        <map:transform type="xslt-saxon" src="xsl/clean.xsl"/>
        <map:transform type="xslt-saxon" src="xsl/sql_selectSubBatchesForCountry.xsl">        
          <map:parameter name="runmode" value="{request-param:runmode}"/>
          <map:parameter name="ct" value="{1}"/>
          <map:parameter name="input_ct" value="{2}"/>
          <map:parameter name="country" value="{3}"/>          
          <map:parameter name="reload" value="{request-param:reload}"/>          
        </map:transform>
        <map:call resource="sql"/>
        <map:select type="parameter">
          <map:parameter name="parameter-selector-test" value="{1}"/>
          <map:when test="PMT">
            <map:transform type="xslt-saxon" src="xsl/include_ctl2createConcurrentEntryRecords.xsl">
              <map:parameter name="timestamp" value="{4}"/>
              <map:parameter name="ct" value="{1}"/>
              <map:parameter name="concurrency" value="{cmc2:PMT.concurrent.batch.sync.includes}"/>
              <map:parameter name="ctURL" value="{cmc2:ctURL}"/>               
            </map:transform>
            <map:transform type="cinclude"/>
          </map:when>
          <map:when test="PCT">
            <map:transform type="xslt-saxon" src="xsl/include_ctl2createConcurrentEntryRecords.xsl">
              <map:parameter name="timestamp" value="{4}"/>
              <map:parameter name="ct" value="{1}"/>
              <map:parameter name="concurrency" value="{cmc2:PCT.concurrent.batch.sync.includes}"/>
              <map:parameter name="ctURL" value="{cmc2:ctURL}"/>               
            </map:transform>
            <map:transform type="cinclude"/>
          </map:when>          
          <map:otherwise>
            <map:transform type="xslt-saxon" src="xsl/include_ctl2createEntryRecords.xsl">
              <map:parameter name="timestamp" value="{4}"/>
              <map:parameter name="ct" value="{1}"/>          
              <map:parameter name="ctURL" value="{cmc2:ctURL}"/>               
            </map:transform>           
            <map:transform type="cinclude"/>
            <!-- process the entry record -->
            <map:transform type="xslt-saxon" src="xsl/process_ctlEntryRecords.xsl">
              <map:parameter name="timestamp" value="{4}"/>
              <map:parameter name="ct" value="{1}"/>          
              <map:parameter name="ctURL" value="{cmc2:ctURL}"/>     
              <map:parameter name="storeURL" value="{request-param:storeURL}"/>
            </map:transform>             
            <map:transform type="cinclude"/>        
          </map:otherwise>
        </map:select>
        <map:serialize type="xml"/>
      </map:match>
      <!--
        Create entry records for a range of batches concurrently.
        
        {1} ct
        {2} input_ct
        {3} country
        {4} timestamp
        
        Request params:
          start_batch_number  starting batch number to process
          end_batch_number    ending batch number to process
      -->
      <map:match pattern="createConcurrentEntryRecords/*/*/*/*">
        <map:generate src="{cmc2:xmlDir}/empty.xml"/>
        <map:transform type="xslt-saxon" src="xsl/include_ctl2createEntryRecords.xsl">
          <map:parameter name="ct" value="{1}"/>
          <map:parameter name="input_ct" value="{2}"/>
          <map:parameter name="country_code" value="{3}"/>
          <map:parameter name="timestamp" value="{4}"/>
          <map:parameter name="start_batch_number" value="{request-param:start_batch_number}"/>
          <map:parameter name="end_batch_number" value="{request-param:end_batch_number}"/>
          <map:parameter name="ctURL" value="{cmc2:ctURL}"/>                         
        </map:transform>
        <map:transform type="include">
          <!-- run concurrently! -->
          <map:parameter name="parallel" value="true"/>
        </map:transform>
        <map:transform type="xslt-saxon" src="xsl/process_ctlEntryRecords.xsl">
          <map:parameter name="timestamp" value="{4}"/>
          <map:parameter name="ct" value="{1}"/>
          <map:parameter name="storeURL" value="{request-param:storeURL}"/>
        </map:transform>
        <map:transform type="include">
          <!-- run concurrently! -->
          <map:parameter name="parallel" value="true"/>
        </map:transform>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="createEntryRecords/*/*/*/*">
      <!--  {1}content_type {2}input content_type {3} country_code {4}timestamp  -->
        <map:generate src="{cmc2:xmlDir}/empty.xml"/>
        <map:transform type="xslt-saxon" src="xsl/sql_select_entry_records.xsl">
          <map:parameter name="ct" value="{1}"/>
          <map:parameter name="input_ct" value="{2}"/>
          <map:parameter name="country_code" value="{3}"/>
          <map:parameter name="ts" value="{4}"/>
          <map:parameter name="reload" value="{request-param:reload}"/>
          <map:parameter name="batch_number" value="{request-param:batch_number}"/>
          <map:parameter name="nosync" value="{request-param:nosync}"/>
        </map:transform>       
        <map:call resource="sql"/>
        <map:transform type="xslt-saxon" src="xsl/include_octl2process.xsl">
          <map:parameter name="runmode" value="{request-param:runmode}"/>
          <map:parameter name="ctURL" value="{cmc2:ctURL}/"/>
          <map:parameter name="ct" value="{1}"/>
          <map:parameter name="ts" value="{4}"/>
        </map:transform>
        <map:transform type="cinclude"/>
        <map:transform src="{cmc2:xslDir}/common/cleanup-sql.xsl"/>
        <map:transform type="xslt-saxon" src="{cmc2:xslDir}/common/writeEntry.xsl">
          <map:parameter name="dir" value="{cmc2:gdir}/{1}"/>
          <map:parameter name="prefix" value="{3}_"/>
        </map:transform>
        <map:transform type="write-source"/>
        <map:serialize type="xml"/>
      </map:match>
    </map:pipeline>
  </map:pipelines>
</map:sitemap>
