<?xml version="1.0"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">
	<map:components>
		<map:transformers default="xslt">
			<map:transformer name="shell" src="org.apache.cocoon.transformation.FileActionsTransformer"/>
		</map:transformers>
	</map:components>
	<map:pipelines>
		<!-- -->
		<map:pipeline name="monitor" type="noncaching">
			<map:match pattern="check!*!*!*">
				<!-- This is the starting point, parameters are:
				  - channel
				  - max time since last start
				  - max time to run
				-->
				<map:generate type="file" src="../common/xml/empty.xml" label="step1"/>
				<map:transform type="xslt-saxon" src="xsl/{global:db}sql_gettimings.xsl" label="step2">
					<map:parameter name="channel" value="{1}"/>
					<map:parameter name="lastrun" value="{2}"/>
					<map:parameter name="maxtime" value="{3}"/>
				</map:transform>
				<!-- Run db queries -->
				<map:transform type="sql" label="step3">
					<map:parameter name="use-connection" value="oracleDbCMC"/>
					<map:parameter name="clob-encoding" value="UTF-8"/>
				</map:transform>
				<map:transform type="xslt-saxon" src="xsl/getlogs.xsl" label="step4"/>
				<map:transform type="include" label="step5"/>
				<map:transform type="xslt-saxon" src="xsl/filterlastlog.xsl" label="step6"/>
				<map:transform type="xslt-saxon" src="xsl/analyze.xsl" label="step7"/>
				<map:serialize type="xml" label="step8"/>
			</map:match>
			<!-- -->
			<map:match pattern="getdir_**">
				<map:generate type="directory" src="{global:gdir}{1}">
					<map:parameter name="dateFormat" value="yyyy-MM-dd HH:mm:ss"/>
					<map:parameter name="depth" value="1"/>
					<map:parameter name="sort" value="lastmodified"/>
					<map:parameter name="reverse" value="true"/>
					<map:parameter name="include" value=".*\.xml"/>
				</map:generate>			
				<map:serialize type="xml"/>
			</map:match>
			<!-- -->
		</map:pipeline>
	</map:pipelines>
	<!-- -->
	<map:views>
		<map:view name="xmldb" from-label="xmldb">
			<map:serialize type="xml"/>
		</map:view>
		<map:view name="xmlprefo" from-label="xmlprefo">
			<map:serialize type="xml"/>
		</map:view>
		<map:view name="xmlfo" from-label="xmlfo">
			<map:serialize type="xml"/>
		</map:view>
		<map:view name="step1" from-label="step1">
			<map:serialize type="xml"/>
		</map:view>
		<map:view name="step2" from-label="step2">
			<map:serialize type="xml"/>
		</map:view>
		<map:view name="step3" from-label="step3">
			<map:serialize type="xml"/>
		</map:view>
		<map:view name="step4" from-label="step4">
			<map:serialize type="xml"/>
		</map:view>
		<map:view name="step5" from-label="step5">
			<map:serialize type="xml"/>
		</map:view>
		<map:view name="step6" from-label="step6">
			<map:serialize type="xml"/>
		</map:view>
	</map:views>
	<!-- -->
</map:sitemap>
