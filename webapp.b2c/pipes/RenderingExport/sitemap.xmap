<?xml version="1.0"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">

  <map:resources>
    <!-- the sql resource provides a central place to edit database details -->
    <map:resource name="sql">
      <map:transform type="sql">
        <map:parameter name="use-connection" value="oracleDbCMC"/>
        <map:parameter name="clob-encoding" value="UTF-8"/>
      </map:transform>
    </map:resource>
  </map:resources>

  <map:components>
    <map:transformers default="xslt">
      <map:transformer name="shell" src="org.apache.cocoon.transformation.FileActionsTransformer"/>
      <map:transformer name="sendmail" src="org.apache.cocoon.mail.transformation.SendMailTransformer">
        <smtphost>nlvg020.gdc1.ce.philips.com</smtphost>
        <smtpport>25</smtpport>
      </map:transformer>
    </map:transformers>

    <map:selectors>
      <map:selector name="parameter" logger="sitemap.selector.parameter" src="org.apache.cocoon.selection.ParameterSelector"/>
    </map:selectors>

    <map:actions>
      <map:action name="synced-copy-source" src="org.apache.cocoon.acting.SyncedCopySourceAction"/>
    </map:actions>

    <map:serializers>
      <map:serializer logger="sitemap.serializer.xml" mime-type="text/xml" name="xml-indented" src="org.apache.cocoon.serialization.XMLSerializer">
        <encoding>UTF-8</encoding>
        <indent>yes</indent>
      </map:serializer>
    </map:serializers>


  </map:components>

  <map:pipelines>
    <!--- -->
    <map:component-configurations>
      <global-variables>
        <ldir>RenderingExport/</ldir>
          <channel>RenderingExport</channel>
      </global-variables>
    </map:component-configurations>
    <!--- -->
    <map:pipeline name="{global:channel}" type="noncaching">
      <!--- -->
      <map:match pattern="full/runPipeline">
        <!-- This is the starting point of the pipeline. A lock is requested to prevent this pipeline from running multiple times in parallel.
             When a lock cannot be acquired, an error message is shown. If a lock can be acquired, run exportMain -->
        <map:act type="synced-copy-source" src="cocoon:/exportStart?batchtype=full">
          <map:parameter name="lockName" value="{global:channel}"/>
          <map:parameter name="dest" value="{global:gdir}{global:ldir}temp/import.xml"/>
          <map:generate src="{global:gdir}{global:ldir}temp/import.xml"/>
          <map:serialize type="xml"/>
        </map:act>
        <map:generate src="../common/xml/locked.xml"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="delta/runPipeline">
        <!-- This is the starting point of the pipeline. A lock is requested to prevent this pipeline from running multiple times in parallel.
             When a lock cannot be acquired, an error message is shown. If a lock can be acquired, run exportMain -->
        <map:act type="synced-copy-source" src="cocoon:/exportStart?batchtype=delta">
          <map:parameter name="lockName" value="{global:channel}"/>
          <map:parameter name="dest" value="{global:gdir}{global:ldir}temp/import.xml"/>
          <map:generate src="{global:gdir}{global:ldir}temp/import.xml"/>
          <map:serialize type="xml"/>
        </map:act>
        <map:generate src="../common/xml/locked.xml"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="exportStart">
        <!-- Set Start Time.of this channel-->
        <map:act type="copy-source" src="cocoon:/runsql_setstarttime">
          <map:parameter name="dest" value="{global:gdir}{global:ldir}temp/ReportSetStartTime.xml"/>
        </map:act>
        <!-- Call the Main Export.-->
        <map:act type="copy-source" src="cocoon:/exportMain?batchtype={request-param:batchtype}">
          <map:parameter name="dest" value="{global:gdir}{global:ldir}temp/ReportExportMain.xml"/>
        </map:act>
        <!-- Create the log file -->
        <map:act type="copy-source" src="cocoon:/createLogFile">
          <map:parameter name="dest" value="{global:gdir}{global:ldir}temp/ReportCreateLog.xml"/>
        </map:act>
        <!-- Do finalization.-->
        <map:act type="copy-source" src="cocoon:/finalize">
          <map:parameter name="dest" value="{global:gdir}{global:ldir}temp/ReportFinalize.xml"/>
        </map:act>
        <!-- Set End Time of this channel-->
        <map:act type="copy-source" src="cocoon:/runsql_setendtime">
          <map:parameter name="dest" value="{global:gdir}{global:ldir}temp/ReportSetEndTime.xml"/>
        </map:act>
        <!-- Show result -->
        <map:act type="copy-source" src="cocoon:/runsql_gettimings">
          <map:parameter name="dest" value="{global:gdir}{global:ldir}temp/ReportGetTimings.xml"/>
        </map:act>
        <map:generate src="{global:gdir}{global:ldir}temp/ReportGetTimings.xml"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- set Start / End Time -->
      <map:match pattern="runsql_*">
        <map:generate src="../common/xml/empty.xml"/>
        <map:transform type="xslt-saxon" src="../common/xsl/sql_{1}.xsl">
          <map:parameter name="channel" value="{global:channel}/{request-param:batchtype}"/>
           <map:parameter name="run_id" value="{request-param:runId}"/>
           <map:parameter name="run_mode" value="{request-param:runmode}"/>
        </map:transform>
        <map:call resource="sql"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="exportMain">
        <map:act type="copy-source" src="cocoon:/deleteTempFiles">
          <map:parameter name="dest" value="{global:gdir}{global:ldir}temp/ReportDeleteTmpFilesReport.xml"/>
        </map:act>
        <map:act type="copy-source" src="cocoon:/deleteOutboxFiles">
          <map:parameter name="dest" value="{global:gdir}{global:ldir}temp/ReportDeleteOutboxFilesReport.xml"/>
        </map:act>
        <!-- Loop over all languages -->
        <map:generate src="../common/xml/empty.xml"/>
        <map:select type="parameter">
          <map:parameter name="parameter-selector-test" value="{request-param:batchtype}"/>
          <map:when test="full">
            <map:transform type="xslt-saxon" src="xsl/sql_deleteHistoryRecords.xsl">
              <map:parameter name="channel" value="{global:channel}" />
            </map:transform>
            <map:call resource="sql"/>
          </map:when>
        </map:select>
        <map:transform type="xslt-saxon" src="xsl/sql_getlocales.xsl" label="stepA1">
          <map:parameter name="channel" value="{global:channel}" />
          <map:parameter name="batchtype" value="{request-param:batchtype}"/>
        </map:transform>
        <map:call resource="sql"/>
        <!-- Transform output to get include statements to batchSub-->
        <map:transform type="xslt-saxon" src="xsl/ll2includeForBatching.xsl" label="stepA3"/>
        <map:transform type="cinclude"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="batchSub.*.*">
        <!-- Idenfity and batch products, ordering on MASTERLASTMODIFIED DESC -->
        <map:generate src="../common/xml/empty.xml"/>
        <map:transform type="xslt-saxon" src="xsl/sql_createbatches.xsl" label="stepB1">  
          <map:parameter name="batchsize" value="500"/>
          <map:parameter name="exportdate" value="{1}"/>
          <map:parameter name="locale" value="{2}"/>
          <map:parameter name="channel" value="{global:channel}"/>
          <map:parameter name="batchtype" value="{request-param:batchtype}"/>
        </map:transform>
        <map:call resource="sql"/>
        <map:transform type="xslt-saxon" src="xsl/sql_selectbatches.xsl" label="stepB3">
          <map:parameter name="locale" value="{2}"/>
          <map:parameter name="channel" value="{global:channel}"/>
        </map:transform>
        <map:call resource="sql"/>
        <map:transform type="xslt-saxon" src="xsl/ll2include.xsl" label="stepB5">
          <map:parameter name="timestamp" value="{1}"/>
          <map:parameter name="locale" value="{2}"/>
        </map:transform>
        <map:transform type="cinclude" label="stepB6"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="exportSub.*.*.*.*">
        <!-- Export per {1} runtimestamp (timestamp + batchnumber seconds), {2} locale, {3} batch number {4} maxbatchnumber-->
        <!--
               E.g.: cocoon:/exportSub.20071026102516.en_GB.1.12 (localized)
                     cocoon:/exportSub.20071030091018.master_global.1    (master)
            -->
			
        <map:select type="parameter">
          <map:parameter name="parameter-selector-test" value="{2}"/>
          <map:when test="master_global">
            <map:act type="copy-source" src="cocoon:/exportRendering.Product.{1}.{2}.{3}.{4}">
              <map:parameter name="dest" value="{global:gdir}{global:ldir}outbox/{1}_Master-CTV-Ctg_{3}.xml"/>
            </map:act>
          </map:when>
          <map:otherwise>
            <map:act type="copy-source" src="cocoon:/exportRendering.Product.{1}.{2}.{3}.{4}">
              <map:parameter name="dest" value="{global:gdir}{global:ldir}outbox/{1}_{2}-CTV-Ctg_{3}.xml"/>
            </map:act>
          </map:otherwise>
        </map:select>
        <map:act type="copy-source" src="cocoon:/genReport.{1}.{2}.{3}">
          <map:parameter name="dest" value="{global:gdir}{global:ldir}temp/FinalReport_{1}_{2}_{3}.xml"/>
        </map:act>
        <map:generate src="{global:gdir}{global:ldir}temp/FinalReport_{1}_{2}_{3}.xml"/>
        <map:serialize type="xml"/>
      </map:match>
      <!--
         | TEST: 
         |   update customer_locale_export set batch=1, flag=1 where customer_id = 'RenderingExport' and locale = 'en_US' and ctn = '19PFL3606H/12';
         |   http://localhost:8888/pipes/RenderingExport/exportRendering.Product.20120926T1754.en_US.1.1?batchtype=delta
         |-->
      <map:match pattern="exportRendering.*.*.*.*.*">
      <!-- Export per {1} type  {2} timestamp,  {3} locale {4} batchnumber {5} maxbatchnumber -->
        <map:generate src="../common/xml/empty.xml" />
        <map:transform type="xslt-saxon" src="xsl/sql_retrieveproducts.xsl">
          <map:parameter name="timestamp" value="{2}"/>
          <map:parameter name="locale" value="{3}"/>
          <map:parameter name="batchnumber" value="{4}"/>
          <map:parameter name="channel" value="{global:channel}"/>
        </map:transform>   
        <map:call resource="sql"/>
        <map:transform type="xslt-saxon" src="xsl/Rendering{1}.xsl">
          <map:parameter name="runtimestamp" value="{2}"/>
          <map:parameter name="batchnumber" value="{4}"/>
          <map:parameter name="maxbatchnumber" value="{5}"/>
          <map:parameter name="batchtype" value="{request-param:batchtype}"/>
        </map:transform>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="createLogFile">
        <map:generate type="xpathdirectory" src="{global:gdir}{global:ldir}temp" label="step1">
          <map:parameter name="xpath" value="/batch"/>
          <map:parameter name="xmlFiles" value="^FinalReport.*\.xml"/>
          <map:parameter name="include" value="^FinalReport.*"/>
        </map:generate>
        <map:transform type="xslt-saxon" src="xsl/makereport.xsl" label="stepA5">
          <map:parameter name="channel" value="{global:channel}"/>
          <map:parameter name="dir" value="{global:gdir}{global:ldir}"/>
          <map:parameter name="exportdate" value="{date:yyyyMMdd}{date:HHmmss}"/>
        </map:transform>
        <map:transform type="write-source" label="stepA6"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="finalize">
        <map:generate src="../common/xml/empty.xml" />
        <map:transform type="xslt-saxon" src="xsl/sql_gettimestamp.xsl" label="stepA11">
          <map:parameter name="channel" value="{global:channel}" />
          <map:parameter name="batchtype" value="{request-param:batchtype}"/>
        </map:transform>
        <map:call resource="sql"/>
        <map:transform type="xslt-saxon" src="xsl/finalise.xsl" label="stepA17">
          <map:parameter name="action" value="CreateContentReady_Locale"/>
        </map:transform>
        <map:transform type="cinclude" label="stepA18"/>
        <map:transform type="xslt-saxon" src="xsl/sql_gettimestamp.xsl" label="stepA11">
          <map:parameter name="channel" value="{global:channel}" />
          <map:parameter name="batchtype" value="{request-param:batchtype}"/>
        </map:transform>
        <map:call resource="sql"/>
        <map:transform type="xslt-saxon" src="xsl/finalise.xsl" label="stepA17">
          <map:parameter name="action" value="CreateContentReady_Master"/>
        </map:transform>
        <map:transform type="cinclude" label="stepA18"/>
        <map:transform type="xslt-saxon" src="xsl/sql_gettimestamp.xsl" label="stepA19">
          <map:parameter name="channel" value="{global:channel}" />
          <map:parameter name="batchtype" value="{request-param:batchtype}"/>
        </map:transform>
        <map:call resource="sql"/>
        <map:transform type="xslt-saxon" src="xsl/finalise.xsl" label="stepA21">
          <map:parameter name="action" value="ArchiveFiles"/>
        </map:transform>
        <map:transform type="cinclude" label="stepA22"/>
        <map:transform type="xslt-saxon" src="xsl/sql_gettimestamp.xsl" label="stepA19">
          <map:parameter name="channel" value="{global:channel}" />
          <map:parameter name="batchtype" value="{request-param:batchtype}"/>
        </map:transform>
        <map:call resource="sql"/>
        <map:transform type="xslt-saxon" src="xsl/finalise.xsl" label="stepA21">
          <map:parameter name="action" value="UpdateExportTimestamps"/>
        </map:transform>
        <map:transform type="cinclude" label="stepA22"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="createContentReadysub.*.*">
        <!-- Create the CONTENT-READY file -->
        <map:generate src="../common/xml/empty.xml"/>
        <map:act type="copy-source" src="cocoon:/createContentReady.{1}.{2}" >
          <map:parameter name="dest" value="{global:gdir}{global:ldir}outbox/{2}_{1}_CONTENT-READY"/>
        </map:act>
        <map:act type="copy-source" src="cocoon:/sendContentReady.{1}.{2}" >
          <map:parameter name="dest" value="{global:gdir}{global:ldir}temp/{1}_{2}_sendContentReady.xml"/>
        </map:act>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="createContentReady.*.*">
        <!-- {Master|Locale}.{Timestamp} -->
        <map:generate src="{global:gdir}{global:ldir}outbox" type="directory" label="stepZ1"/>
        <map:transform src="xsl/dir2pipeline.xsl" label="stepZ2">
          <map:parameter name="sourceDir" value="{global:gdir}{global:ldir}outbox"/>
          <map:parameter name="targetDir" value="{global:gdir}{global:ldir}archive"/>
          <map:parameter name="action" value="readFile"/>
          <map:parameter name="localetype" value="{1}"/>
          <map:parameter name="timestamp" value="{2}"/>
        </map:transform>
        <map:transform type="cinclude" label="stepZ3"/>
        <map:serialize type="text"/>
      </map:match>
      <!-- -->
      <map:match pattern="readFile_*.*.*">
        <!-- cocoon:/readFile_Locale.20071031161518.20071031161518_Master_1-CTV.xml -->
        <map:generate src="../common/xml/empty.xml"/>
        <map:transform type="xslt-saxon" src="xsl/generateContentReady.xsl" label="stepZ4">
          <map:parameter name="sourceDir" value="{global:gdir}{global:ldir}outbox"/>
          <map:parameter name="localetype" value="{1}"/>
          <map:parameter name="timestamp" value="{2}"/>
          <map:parameter name="sourceFile" value="{3}"/>
        </map:transform>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="sendContentReady.*.*">
        <map:generate type="directory" src="{global:gdir}{global:ldir}outbox">
          <map:parameter name="dateFormat" value="yyyy-MM-dd hh:mm"/>
          <map:parameter name="depth" value="1"/>
          <map:parameter name="include" value="{2}_{1}_CONTENT-READY"/>
        </map:generate>
        <map:transform type="xslt-saxon" src="xsl/sendContentReady.xsl">
          <map:parameter name="host" value="{cmc2:cocoonServer}"/>
          <map:parameter name="sender" value="{cmc2:emailSender}"/>
          <map:parameter name="recipient" value="nlsupport@sdl.com"/>
          <map:parameter name="localetype" value="{1}"/>
        </map:transform>
        <!--map:transform type="sendmail"/-->
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="file_*">
        <map:read src="{global:gdir}{global:ldir}outbox/{1}" mime-type="text"/>
      </map:match>
      <!-- -->
      <map:match pattern="createFakeExportFile.*.*">
        <!-- {Master|Locale}.{Timestamp} -->
        <map:generate src="../common/xml/empty.xml"/>
        <map:transform src="xsl/createFakeExportFile.xsl" label="stepZ2">
          <map:parameter name="targetDir" value="{global:gdir}{global:ldir}archive"/>
          <map:parameter name="localetype" value="{1}"/>
          <map:parameter name="timestamp" value="{2}"/>
        </map:transform>
        <map:transform type="write-source" label="stepA6"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="genReport.*.*.*">
        <map:generate src="../common/xml/empty.xml"/>
        <map:transform src="xsl/sql_genreport.xsl">
          <map:parameter name="exportdate" value="{1}"/>
          <map:parameter name="locale" value="{2}"/>
          <map:parameter name="batch" value="{3}"/>
          <map:parameter name="channel" value="{global:channel}"/>
        </map:transform>
        <map:call resource="sql"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="updateExportTimestamps.*">
        <map:generate src="../common/xml/empty.xml"/>
        <map:transform src="xsl/sql_updatetransmitdate.xsl">
          <map:parameter name="exportdate" value="{1}"/>
          <map:parameter name="channel" value="{global:channel}"/>
        </map:transform>
        <map:call resource="sql"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="archiveFiles.*">
        <map:generate type="directory" src="{global:gdir}{global:ldir}outbox" label="stepZ6">
          <map:parameter name="dateFormat" value="yyyy-MM-dd hh:mm"/>
          <map:parameter name="depth" value="1"/>
          <map:parameter name="include" value=".*"/>
        </map:generate>
        <map:transform src="xsl/dir2pipeline.xsl" label="stepZ7">
          <map:parameter name="action" value="archiveFile"/>
          <map:parameter name="timestamp" value="{1}"/>
        </map:transform>
        <map:transform type="cinclude" label="stepZ8"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="archiveFile_*.*">
        <map:generate src="../common/xml/empty.xml"/>
        <map:transform src="xsl/dir2shell_move.xsl" label="stepX1">
          <map:parameter name="sourceDir" value="{global:gdir}{global:ldir}outbox"/>
          <map:parameter name="timestamp" value="{1}"/>
          <map:parameter name="sourceFile" value="{2}"/>
          <map:parameter name="targetDir" value="{global:gdir}{global:ldir}archive/{1}"/>
        </map:transform>
        <map:transform type="shell"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="deleteTempFiles">
        <map:generate type="directory" src="{global:gdir}{global:ldir}temp" label="step1">
          <map:parameter name="dateFormat" value="yyyy-MM-dd hh:mm"/>
          <map:parameter name="depth" value="3"/>
          <map:parameter name="include" value=".*"/>
        </map:generate>
        <map:transform src="xsl/dir2shell_delete.xsl" label="step2">
          <map:parameter name="dir" value="{global:gdir}{global:ldir}temp"/>
          <map:parameter name="leaf" value="temp"/>
        </map:transform>
        <map:transform type="shell" label="step3"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="deleteOutboxFiles">
        <map:generate type="directory" src="{global:gdir}{global:ldir}outbox" label="step1">
          <map:parameter name="dateFormat" value="yyyy-MM-dd hh:mm"/>
          <map:parameter name="depth" value="3"/>
          <map:parameter name="include" value=".*"/>
        </map:generate>
        <map:transform src="xsl/dir2shell_delete.xsl" label="step2">
          <map:parameter name="dir" value="{global:gdir}{global:ldir}outbox"/>
          <map:parameter name="leaf" value="outbox"/>
        </map:transform>
        <map:transform type="shell" label="step3"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->

      <map:match pattern="testPipeline">
        <map:act type="copy-source" src="cocoon:/restoreTestFiles">
          <map:parameter name="dest" value="{global:gdir}{global:ldir}temp/RestoreTestFilesReport.xml"/>
        </map:act>
        <!-- -->
        <map:act type="copy-source" src="cocoon:/runPipeline">
           <map:parameter name="dest" value="{global:gdir}{global:ldir}temp/runPipeline.xml"/>
        </map:act>
        <map:generate src="{global:gdir}{global:ldir}temp/runPipeline.xml"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="restoreTestFiles">
        <map:generate type="directory" src="{global:gdir}{global:ldir}testdata">
          <map:parameter name="dateFormat" value="yyyy-MM-dd hh:mm"/>
          <map:parameter name="depth" value="1"/>
          <map:parameter name="include" value=".*"/>
        </map:generate>
        <map:transform src="../common/xsl/dir2shell_move.xsl">
          <map:parameter name="sourceDir" value="{global:gdir}{global:ldir}testdata"/>
          <map:parameter name="targetDir" value="{global:gdir}{global:ldir}inbox"/>
        </map:transform>
        <map:transform type="shell"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="restoreArchiveFiles">
        <map:generate type="directory" src="{global:gdir}{global:ldir}archive">
          <map:parameter name="dateFormat" value="yyyy-MM-dd hh:mm"/>
          <map:parameter name="depth" value="1"/>
          <map:parameter name="include" value=".*"/>
        </map:generate>
        <!-- Move files to inbox  -->
        <map:transform src="../common/xsl/dir2shell_move.xsl">
          <map:parameter name="sourceDir" value="{global:gdir}{global:ldir}archive"/>
          <map:parameter name="targetDir" value="inbox"/>
        </map:transform>
        <map:transform type="shell"/>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
      <map:match pattern="deleteArchiveFiles">
        <map:generate type="directory" src="{global:gdir}{global:ldir}archive">
          <map:parameter name="dateFormat" value="yyyy-MM-dd hh:mm"/>
          <map:parameter name="depth" value="1"/>
          <map:parameter name="include" value=".*"/>
        </map:generate>
        <map:transform src="../common/xsl/dir2shell_delete.xsl">
          <map:parameter name="dir" value="{global:gdir}{global:ldir}archive"/>
        </map:transform>
        <map:transform type="shell" />
        <map:serialize type="xml"/>
      </map:match>
    </map:pipeline>
  </map:pipelines>
   <!-- -->
   <map:views>
      <map:view name="stepX" from-label="stepX">
         <map:serialize type="xml"/>
      </map:view>
   </map:views>
   <!-- -->
</map:sitemap>
