<?xml version="1.0"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">
	<map:components>
		<map:transformers default="xslt">
			<map:transformer name="shell" src="org.apache.cocoon.transformation.FileActionsTransformer"/>
		</map:transformers>		
		<map:actions>
			<map:action name="synced-copy-source" src="org.apache.cocoon.acting.SyncedCopySourceAction"/>
		</map:actions>
	</map:components>
	
	<map:pipelines>
		<!--- -->
		<map:component-configurations>
			<global-variables>
				<ldir>MainChannelReport/</ldir>
			</global-variables>
		</map:component-configurations>
		<!--- -->
		<map:pipeline name="MainChannelReport" type="noncaching">
			<!--- -->
			<map:match pattern="runPipeline">
				<!-- This is the starting point of the pipeline. A lock is requested to prevent this pipeline from running multiple times in parallel.
				When a lock cannot be acquired, an error message is shown. If a lock can be acquired, run exportMain -->
				<map:act type="synced-copy-source" src="cocoon:/pipeMain">
					<map:parameter name="lockName" value="MainChannelReport"/>
					<map:parameter name="dest" value="{global:gdir}{global:ldir}temp/pipe.xml"/>
					<map:generate src="{global:gdir}{global:ldir}temp/pipe.xml"/>
					<map:serialize type="xml"/>
				</map:act>
				<map:generate src="../common/xml/locked.xml"/>
				<map:serialize type="xml"/>
			</map:match>
			<!-- -->
			
			<map:match pattern="pipeMain">
				<!-- Delete all files in the {global:gdir}{global:ldir}temp directory. Write the results of this action to a report.-->
				<map:act type="copy-source" src="cocoon:/deleteTempFiles">
					<map:parameter name="dest" value="{global:gdir}{global:ldir}temp/ReportDeleteTmpFilesReport.xml"/>
				</map:act>
				
				<map:act type="copy-source" src="cocoon:/RunReport">
					<map:parameter name="dest" value="{global:gdir}{global:ldir}temp/runReportReport.xml"/>
				</map:act>
				
				
				<map:generate src="{global:gdir}{global:ldir}temp/runReportReport.xml"/>
				<map:serialize type="xml"/>
			</map:match>
			<!-- -->
			
			<map:match pattern="RunReport">
				<map:generate src="../common/xml/empty.xml"/>
				<map:transform src="xsl/sql_getChannelsData.xsl" label="step1">
				</map:transform>
				<!-- Run db queries -->
				<map:transform type="sql" label="step2">
					<map:parameter name="use-connection" value="oracleDbCMC"/>
					<map:parameter name="clob-encoding" value="UTF-8"/>
				</map:transform>
				<map:transform src="xsl/runChannelReport.xsl" label="step3"/>
				<map:transform type="cinclude"/>				
				<map:serialize type="xml"/>			
			</map:match>

			
			<map:match pattern="channelReport_*_*">
				<!-- Retrieve all log files files under {global:gdir} -->
				<map:generate type="directory" src="{global:gdir}{1}/logs">
					<map:parameter name="dateFormat" value="yyyy-MM-dd hh:mm"/>
					<map:parameter name="depth" value="1"/>
					<map:parameter name="include" value=".*.xml"/>
				</map:generate>
				<!-- -->
				<map:transform type="xslt-saxon" src="xsl/runFileReport.xsl">
					<map:parameter name="dir" value="{1}/logs"/>
				</map:transform>
				<!-- map:transform type="cinclude"/ -->
				<map:serialize type="xml"/>
			</map:match>
			<!-- -->
			
			<map:match pattern="fileReport_*_*">
				<!-- Retrieve all log files files under {global:gdir} -->
				<map:generate src="{global:gdir}{1}/logs/{2}"/>

				<!--map:transform type="xslt-saxon" src="xsl/dir2shell_purge.xsl">
					<map:parameter name="dir" value="{global:gdir}{1}/archive"/>
				</map:transform -->
				
				<map:transform type="xslt-saxon" src="xsl/jdb.xsl" />
				<map:serialize type="xml"/>
			</map:match>

			<map:match pattern="deleteTempFiles">
				<!-- Delete all files in {global:gdir}{global:ldir}temp directory -->
				<!-- Retrieve all files in {global:gdir}{global:ldir}temp directory -->
				<map:generate type="directory" src="{global:gdir}{global:ldir}temp">
					<map:parameter name="dateFormat" value="yyyy-MM-dd hh:mm"/>
					<map:parameter name="depth" value="1"/>
					<map:parameter name="include" value=".*"/>
				</map:generate>
				<!-- Delete all files -->
				<map:transform src="../common/xsl/dir2shell_delete.xsl">
					<map:parameter name="dir" value="{global:gdir}{global:ldir}temp"/>
				</map:transform>
				<map:transform type="shell"/>
				<map:serialize type="xml"/>
			</map:match>
			<!-- -->

			<!-- -->
			
		</map:pipeline>
	</map:pipelines>
	
	<map:views>
		<map:view name="xmldb" from-label="xmldb">
			<map:serialize type="xml"/>
		</map:view>
		<map:view name="xmlprefo" from-label="xmlprefo">
			<map:serialize type="xml"/>
		</map:view>
		<map:view name="xmlfo" from-label="xmlfo">
			<map:serialize type="xml"/>
		</map:view>
		<map:view name="step1" from-label="step1">
			<map:serialize type="xml"/>
		</map:view>
		<map:view name="step2" from-label="step2">
			<map:serialize type="xml"/>
		</map:view>
		<map:view name="step3" from-label="step3">
			<map:serialize type="xml"/>
		</map:view>
		<map:view name="step4" from-label="step4">
			<map:serialize type="xml"/>
		</map:view>
		<map:view name="step5" from-label="step5">
			<map:serialize type="xml"/>
		</map:view>
		<map:view name="step6" from-label="step6">
			<map:serialize type="xml"/>
		</map:view>
	</map:views>

</map:sitemap>
