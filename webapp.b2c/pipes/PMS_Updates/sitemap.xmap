<?xml version="1.0" encoding="UTF-8"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">
  <map:components>
    <map:actions>
      <map:action name="synced-copy-source" src="org.apache.cocoon.acting.SyncedCopySourceAction"/>
    </map:actions>
  </map:components>

  <map:resources>
    <!-- the sql resource provides a central place to edit database details -->
    <map:resource name="sql">
      <map:transform type="sql">
        <map:parameter name="use-connection" value="oracleDbCMC" />
        <map:parameter name="clob-encoding" value="UTF-8" />
      </map:transform>
    </map:resource>
  </map:resources>

  <!--
    Recalculate the rank of all the PMS Alerts.
    
    Request params:
    purge     If empty, the rank of all the PMS Alerts is recalculated.
              Otherwise the parameter objects can hold a comma separated list of CTN's that need to be processed.
  -->
  <map:pipelines>
    
    <map:component-configurations>
      <global-variables>
        <ldir>PMS_Updates/</ldir>
        <channel>PMS_Updates</channel>
      </global-variables>
    </map:component-configurations>
    
    <map:pipeline name="{global:channel}" type="noncaching">
      
      <map:match pattern="runPipeline">
        <!--
          This is the starting point of the pipeline. A lock is requested to prevent this pipeline from running multiple times in parallel.
          When a lock cannot be acquired, an error message is shown. If a lock can be acquired, run exportMain
        -->
        <map:act type="synced-copy-source" src="cocoon:/start">
          <map:parameter name="lockName" value="{global:channel}"/>
          <map:parameter name="dest" value="{global:gdir}{global:ldir}logs/Report_{date:yyyyMMdd}T{date:HHmmss}.xml"/>
          <map:generate src="{global:gdir}{global:ldir}temp/PMSDatabase_report.xml"/>
          <map:serialize type="xml"/>
        </map:act>
        <map:generate src="../common/xml/locked.xml"/>
        <map:serialize type="xml"/>
      </map:match>

      <map:match pattern="start">
        <map:act type="copy-source" src="cocoon:/deleteTempFiles">
          <map:parameter name="dest" value="{global:gdir}{global:ldir}temp/ReportDeleteTmpFilesReport.xml"/>
        </map:act>
        <map:act type="copy-source" src="cocoon:/runsql_setstarttime">
          <map:parameter name="dest" value="{global:gdir}{global:ldir}temp/ReportSetStartTime.xml" />
        </map:act>
         <map:act type="copy-source" src="cocoon:/process">
           <map:parameter name="dest" value="{global:gdir}{global:ldir}temp/PMSDatabase_report.xml" />
         </map:act>
         <map:act type="copy-source" src="cocoon:/runsql_setendtime">
           <map:parameter name="dest" value="{global:gdir}{global:ldir}temp/ReportSetEndTime.xml" />
         </map:act>
         <!-- Show result -->
         <map:act type="copy-source" src="cocoon:/runsql_gettimings">
           <map:parameter name="dest" value="{global:gdir}{global:ldir}temp/ReportGetTimings.xml" />
         </map:act>
         <map:generate src="{global:gdir}{global:ldir}temp/ReportGetTimings.xml" />
         <map:serialize type="xml" />
      </map:match>
      
      <map:match pattern="process">
        <map:generate src="{cmc2:xmlDir}/empty.xml" />
        <map:transform src="xsl/process.xsl">
          <map:parameter name="objects" value="{request-param:objects}" />
        </map:transform>
        <map:call resource="sql" />
        <map:serialize type="xml" />
      </map:match>
      
      <map:match pattern="deleteTempFiles">
        <!-- Delete all files in {global:gdir}{global:ldir}temp directory -->
        <!-- Retrieve all files in {global:gdir}{global:ldir}temp directory -->
        <map:generate type="directory" src="{global:gdir}{global:ldir}temp">
          <map:parameter name="dateFormat" value="yyyy-MM-dd hh:mm"/>
          <map:parameter name="depth" value="1"/>
          <map:parameter name="include" value=".*"/>
        </map:generate>
        <!-- Delete all files -->
        <map:transform src="../common/xsl/dir2shell_delete.xsl">
          <map:parameter name="dir" value="{global:gdir}{global:ldir}temp"/>
        </map:transform>
        <map:transform type="shell"/>
        <map:serialize type="xml"/>
      </map:match>

      <map:match pattern="runsql_*">
        <map:generate src="../common/xml/empty.xml" />
        <map:transform type="xslt-saxon" src="../common/xsl/{global:db}sql_{1}.xsl">
          <map:parameter name="channel" value="{global:channel}" />
           <map:parameter name="run_id" value="{request-param:runId}"/>
           <map:parameter name="run_mode" value="{request-param:runmode}"/>
        </map:transform>
        <!-- Run db queries -->
        <map:call resource="sql"/>
        <map:serialize type="xml" />
      </map:match>

    </map:pipeline>
    
  </map:pipelines>
</map:sitemap>
