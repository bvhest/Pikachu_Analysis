<?xml version="1.0" encoding="UTF-8"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">
  <map:components>
    <map:actions>
      <map:action name="synced-copy-source" src="org.apache.cocoon.acting.SyncedCopySourceAction"/>
    </map:actions>
  </map:components>

  <map:resources>
    <!-- the sql resource provides a central place to edit database details -->
    <map:resource name="sql">
      <map:transform type="sql">
        <map:parameter name="use-connection" value="oracleDbCMC" />
        <map:parameter name="clob-encoding" value="UTF-8" />
      </map:transform>
    </map:resource>
  </map:resources>

  <!--
  
	Following pipeline is typically executed by 'http://localhost:8888/pipes/QualityCheck/runPipeline?ext=xml&testtype=NS'.
	Where:

	ext			-	defines the extension of the files to be checked (not active right now)
	testtype	-	defines the test to be performed.
              
  -->
  <map:pipelines>

    <map:component-configurations>
      <global-variables>
        <gdir>..</gdir>
        <!--gdir>../../../webapp.ocb</gdir-->
        <ldir>QualityCheck</ldir>
      </global-variables>
    </map:component-configurations>

    <map:pipeline type="noncaching">
      <!--map:match pattern="runMain/*"-->
      <map:match pattern="runPipeline">
        <!--
          This is the starting point of the pipeline. A lock is requested to prevent this pipeline from running multiple times in parallel.
          When a lock cannot be acquired, an error message is shown. If a lock can be acquired, run startCheck.
		  Perhaps a lock isn't needed since no database actions are performed, if so it can be removed.
        -->
        <map:act type="synced-copy-source" src="cocoon:/startCheck">
          <map:parameter name="lockName" value="{global:channel}"/>
          <map:parameter name="dest" value="{global:gdir}/{global:ldir}/temp/import.xml"/><!-- Most probably this path to import.xml is wrong. -->
          <map:generate src="{global:gdir}/{global:ldir}/temp/import.xml"/>				<!-- Most probably this path to import.xml is wrong. -->
          <map:serialize type="xml"/>
        </map:act>
        <map:generate src="../common/xml/locked.xml"/>
        <map:serialize type="xml"/>
      </map:match>
      
      <!-- -->
      <map:match pattern="startCheck">
        <map:generate type="directory" src="{global:gdir}">
          <map:parameter name="dateFormat" value="yyyy-MM-dd hh:mm"/>
          <map:parameter name="depth" value="10"/>
          <map:parameter name="include" value=".*"/>
          <map:parameter name="exclude" value=".svn|WEB-INF|samples"/>
        </map:generate>
        <map:transform src="xsl/cleanDir.xsl" type="xslt-saxon">
			<map:parameter name="ext" value="{request-param:ext}"/>		
			<!--map:parameter name="ext" value="xsl"/-->		
			<!--map:parameter name="ext" value="process.xsl"/-->
			<!--map:parameter name="ext" value="_batch_results.xsl"/-->
          <map:parameter name="mode" value="{request-param:mode}"/>	
		</map:transform>
        <map:transform src="xsl/ll2include.xsl" type="xslt-saxon"/>
		<map:transform type="include"/>
        <!-- generate report -->
        <map:transform type="xslt-saxon" src="xsl/makereport.xsl">
          <map:parameter name="dir" value=""/>
		  <map:parameter name="reporttype" value="{request-param:testtype}"/>
        </map:transform>
        <map:transform type="write-source"/>
        <map:serialize type="xml" />
      </map:match>
	  
	  <map:match pattern="checkFile/**">
		<map:generate src="{global:gdir}/{1}"/>

        <map:select type="parameter">
			<!-- Value of the request parameter 'testtype' determines which test is performed. -->
			<map:parameter name="parameter-selector-test" value="{request-param:testtype}"/>
			<map:when test="XSD">
				<!--map:transform type="validate" src="xsd/???.xsd"/-->
			</map:when>
			<map:when test="RNG">
				<map:transform type="validation-report" src="xsd/xslt20.rng"/>
			</map:when>
			<map:when test="XSLT">
				<map:transform src="xsl/XSLT-Conformance/check-Conformance.xsl" type="xslt-saxon">
					<map:parameter name="filename" value="{1}"/>
				</map:transform>
			</map:when>
			<map:when test="SQL">
				<map:transform src="xsl/XSLT-Conformance/find-Query.xsl" type="xslt-saxon">
					<map:parameter name="filename" value="{1}"/>
				</map:transform>
			</map:when>
			<map:when test="NS">
				<map:transform src="xsl/XSLT-Conformance/find-Namespaces.xsl" type="xslt-saxon">
					<map:parameter name="filename" value="{1}"/>
				</map:transform>
			</map:when>
			<map:when test="Locale">
				<map:transform src="xsl/XSLT-Conformance/get-Locales.xsl" type="xslt-saxon">
					<map:parameter name="filename" value="{1}"/>
				</map:transform>
			</map:when>
		</map:select>
        <map:serialize type="xml" />
	  </map:match>
    </map:pipeline>
  </map:pipelines>
</map:sitemap>
