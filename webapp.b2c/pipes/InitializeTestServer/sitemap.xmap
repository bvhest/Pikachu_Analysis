<?xml version="1.0"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">
  <map:components>
    <map:transformers default="xslt-saxon" />
    <map:actions>
      <map:action name="synced-copy-source" src="org.apache.cocoon.acting.SyncedCopySourceAction" />
    </map:actions>
  </map:components>
  <map:resources>
    <map:resource name="sql">
      <map:transform type="sql">
        <map:parameter name="use-connection" value="oracleDbCMC" />
        <map:parameter name="clob-encoding" value="UTF-8" />
      </map:transform>
    </map:resource>
  </map:resources>

  <map:pipelines>
    <map:component-configurations>
      <global-variables>
        <channel>InitializeTestServer</channel>
        <ldir>InitializeTestServer/</ldir>
      </global-variables>
    </map:component-configurations>

    <map:pipeline name="Generic" type="noncaching">

      <map:match pattern="runPipeline">
        <map:act type="synced-copy-source" src="cocoon:/init.{date:yyyyMMddhhmmss}">
          <map:parameter name="lockName" value="{global:channel}" />
          <map:parameter name="dest" value="{global:gdir}{global:ldir}temp/report.xml" />
          <map:generate src="{global:gdir}{global:ldir}temp/report.xml" />
          <map:serialize type="xml" />
        </map:act>
        <map:generate src="../common/xml/locked.xml" />
        <map:serialize type="xml" />
      </map:match>
      
	  <!-- {1} timestamp -->
      <map:match pattern="init.*">
        <map:act type="copy-source" src="cocoon:/initDB.{1}">
          <map:parameter name="dest" value="{global:gdir}{global:ldir}/temp/Report_initDB.xml"/>
        </map:act>
        
        <map:aggregate element="reports">
          <map:part src="{global:gdir}{global:ldir}/temp/Report_initDB.xml"/>
        </map:aggregate>
        <map:transform src="xsl/writereport.xsl">
          <map:parameter name="dest" value="{global:gdir}{global:ldir}/logs/Report_{1}.xml"/>
        </map:transform>
        <map:transform type="write-source"/>
        <map:serialize type="xml"/>
      </map:match>
      
      <!--
        {1} timestamp
      -->
      <map:match pattern="initDB.*">
        <map:generate src="../common/xml/empty.xml"/>
        <map:transform src="xsl/initDB.xsl"/>
        <map:call resource="sql"/>
        <map:serialize type="xml" />
      </map:match>
    </map:pipeline>
  </map:pipelines>
</map:sitemap>
