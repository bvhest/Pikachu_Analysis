<?xml version="1.0"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">
  <map:components>
    <map:transformers default="xslt-saxon">
      <map:transformer name="shell" src="org.apache.cocoon.transformation.FileActionsTransformer"/>
    </map:transformers>
  </map:components>
  <!-- -->
  <map:resources>
    <map:resource name="sql">
      <map:transform type="sql">
        <map:parameter name="use-connection" value="oracleDbCMC"/>
        <map:parameter name="clob-encoding" value="UTF-8"/>
      </map:transform>
    </map:resource>
  </map:resources>

  <!-- 
    If the export created a MASTER file the file is copied for each locale that has
    the masterlocaleenabled column in channel_catalogs set to 1.
    This is required because Atg wants the master trees as en_* locales, eg. en_NL, en_DE, etc.
  -->
  <map:pipelines>
    <map:component-configurations>
      <global-variables>
        <channel>ShopCats</channel>
        <ldir>ShopCats/</ldir>
      </global-variables>
    </map:component-configurations>

    <map:pipeline name="{global:channel}" type="noncaching">
      <!-- 
        {1} timestamp
      -->
      <map:match pattern="run/*">
        <map:aggregate element="root">
          <map:part src="cocoon:/getLocalesForMaster" />
          <map:part src="cocoon:/readMasterExportFile" />
        </map:aggregate>
        <map:transform src="xsl/copyMasterTree.xsl">
          <map:parameter name="ts" value="{1}" />
          <map:parameter name="dir" value="../../{global:gdir}{global:ldir}outbox" />
        </map:transform>
        <map:transform type="write-source" />
        <map:transform type="shell" />
        <map:serialize type="xml" />
      </map:match>
      
      <map:match pattern="readMasterExportFile">
        <map:generate type="directory" src="../../{global:gdir}{global:ldir}outbox">
          <map:parameter name="dateFormat" value="yyyy-MM-dd hh:mm" />
          <map:parameter name="sort" value="lastmodified" />
          <map:parameter name="reverse" value="false" />
          <map:parameter name="include" value="^ShopCats_.*_MASTER\.xml$" />
        </map:generate>
        <map:transform src="xsl/dir2readMasterFile.xsl" />
        <map:transform type="include" />
        <map:serialize type="xml" />
      </map:match>
      
      <map:match pattern="read/*.xml">
        <map:generate src="../../{global:gdir}{global:ldir}outbox/{1}.xml" />
        <map:serialize type="xml" />
      </map:match>
      
      <map:match pattern="getLocalesForMaster">
        <map:generate src="../../../common/xml/empty.xml" />
        <map:transform src="xsl/sql_getlocalesformaster.xsl">
          <map:parameter name="channel" value="{global:channel}" />
        </map:transform>
        <map:call resource="sql" />
        <map:serialize type="xml" />
      </map:match>
    </map:pipeline>
  </map:pipelines>
</map:sitemap>
