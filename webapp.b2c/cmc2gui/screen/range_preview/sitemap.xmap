<?xml version="1.0"?>
<map:sitemap xmlns:map="http://apache.org/cocoon/sitemap/1.0">
  <!-- =========================== Components ================================ -->
  <map:components>
  <map:transformers>
  <!--map:transformer name="dump" logger="sitemap.transformer.dump" src="com.philips.cocoon.transformation.DumpTransformer"/-->
  </map:transformers>
	</map:components>
  <!-- =========================== Resources =============================== -->
  <map:resources>
    <map:resource name="sql">
      <map:transform type="sql">
        <map:parameter name="use-connection" value="oracleDbCMC"/>
        <map:parameter name="clob-encoding" value="UTF-8"/>
      </map:transform>
    </map:resource>  
	</map:resources>
  <!-- =========================== Pipelines ================================= -->
  <map:pipelines>
    <!-- use case pipeline - URI request handling -->
    <map:pipeline type="noncaching">
      <!-- -->
      <map:match pattern="range_preview.xml">
				<map:select type="resource-exists">
					<map:when test="../../{global:cmc2xslt}/{request-param:param1}.xsl">
						<map:generate src="cocoon:/{global:gui_url}xmlraw/object_store/{request-param:param1}/{request-param:param2}/{request-param:param3}.xml?id={request-param:id}" label="source"/>
						<map:transform type="xslt-saxon" src="sql_getReferencedProducts.xsl" label="sql_refproducts">
							<map:parameter name="locale" value="{request-param:param2}"/>
						</map:transform>
						<map:call resource="sql" label="sql_loaded"/>
						<map:transform type="xslt-saxon" src="clean_sql.xsl" label="sql_clean"/>
						<map:transform type="xslt-saxon" src="../../{global:cmc2xslt}/{request-param:param1}.xsl" label="preview"/>
					</map:when>
					<map:otherwise>
						<map:generate src="nopreview.xml"/>
					</map:otherwise>
				</map:select>
        <map:serialize type="xml"/>
      </map:match>
      <!-- -->
    </map:pipeline>
  </map:pipelines>
	<!-- -->
	<map:views>
		<map:view name="source" from-label="source">
			<map:serialize type="xml"/>
		</map:view>
		<map:view name="sql_refproducts" from-label="sql_refproducts">
			<map:serialize type="xml"/>
		</map:view>
		<map:view name="sql_loaded" from-label="sql_loaded">
			<map:serialize type="xml"/>
		</map:view>
		<map:view name="sql_clean" from-label="sql_clean">
			<map:serialize type="xml"/>
		</map:view>
		<map:view name="preview" from-label="preview">
			<map:serialize type="xml"/>
		</map:view>
	</map:views>
	<!-- -->
</map:sitemap>
